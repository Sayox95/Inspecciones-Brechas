<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0b1220"/>
  <link rel="icon" href="data:,">
  <title>Captura de Brechas ‚Äî Single HTML (2025-10 v2)</title>

  <style>
    :root{
      --bg:#0b1220;--card:#0f182a;--muted:#8aa0b6;--text:#ecf3ff;
      --accent:#4cc9f0;--ok:#22c55e;--warn:#f97316;--danger:#ef4444;
      --border:#1d2a45;--sheet:#0b1220;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:var(--bg);color:var(--text);overflow:hidden}
    header{position:fixed;top:0;left:0;right:0;z-index:10;
      display:flex;align-items:center;gap:10px;
      background:rgba(11,18,32,.9);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border);padding:12px 14px}
    header h1{margin:0;font-size:16px}
    header .muted{color:var(--muted);font-size:12px}
    #map{position:absolute;inset:84px 0 0 0;background:#0c1425}
    #net{position:fixed;left:0;right:0;top:52px;z-index:11;
      background:#39250b;color:#ffddae;border-bottom:1px solid #5b3a11;
      padding:6px 10px;font-size:12px;display:none}
    .fab{position:fixed;right:16px;bottom:16px;z-index:1100;
      border:0;border-radius:999px;background:var(--accent);color:#051423;
      padding:14px 16px;font-weight:800;box-shadow:var(--shadow);}
    .fab:active{transform:translateY(1px)}
    .fab[disabled]{opacity:.6;pointer-events:none}

    /* Bottom Sheet */
    .sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:2000;
      background:var(--sheet);border-top-left-radius:20px;border-top-right-radius:20px;
      border:1px solid var(--border);box-shadow:0 -12px 30px rgba(0,0,0,.45);
      transition:bottom .28s ease;max-height:82vh;display:flex;flex-direction:column}
    .sheet.open{bottom:0}
    .sheet .drag{width:56px;height:5px;border-radius:999px;background:#24314f;margin:8px auto}
    .sheet .content{padding:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],select,input[type="file"]{
      width:100%;background:#0e1729;color:var(--text);
      border:1px solid #1f2c49;border-radius:12px;padding:10px 12px;font-size:14px
    }
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;
      background:#183055;color:#e6f0ff;width:100%;font-weight:700}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .btn-primary{background:var(--accent);color:#051423}
    .btn-ok{background:var(--ok);color:#06240e}
    .btn-warn{background:var(--warn);color:#2b0d02}
    .btn-ghost{background:#0e1729;border:1px solid #203153;color:#d7e5ff}
    .btn-danger{background:var(--danger);}
    .bar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;background:#0e1729;border:1px solid #22355c;font-size:12px;color:var(--muted)}
    .color-box{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle}
    .apertura{background:var(--warn)} .limpieza{background:var(--ok)}
    .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)}
    .hidden{display:none!important}

    /* Summary card */
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    img.preview{width:160px;height:auto;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:transform .2s ease}
    img.preview:hover{transform:scale(1.05)}

    /* Popup content */
    .popup-title{font-weight:800;margin-bottom:4px}
    .popup-meta{font-size:12px;color:#9fb3c7}
    .popup-img{width:200px;max-width:80vw;border-radius:10px;margin-top:6px;border:1px solid #1f2c49}

    .pending-banner{position:fixed;left:0;right:0;bottom:0;z-index:1500;
      background:#2a1d0b;color:#ffe7c2;border-top:1px solid #4b2e0f;
      padding:8px 12px;font-size:13px;display:none}
    .pending-banner strong{color:#ffd39a}

    /* Fullscreen blocker */
    .blocker{
      position:fixed; inset:0; z-index:3000;
      display:none; align-items:center; justify-content:center;
      background:rgba(5,10,20,.55); backdrop-filter:blur(2px);
    }
    .blocker .box{
      background:#0e1729; border:1px solid #203153; color:#eaf2ff;
      padding:16px 18px; border-radius:14px; min-width:240px;
      box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center;
      font-weight:600;
    }
    .spinner{
      width:22px; height:22px; border-radius:50%;
      border:3px solid #29436f; border-top-color:#4cc9f0;
      animation:sp 0.9s linear infinite; display:inline-block; margin-right:10px;
      vertical-align:middle;
    }
    @keyframes sp{to{transform:rotate(360deg);}}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:#0e1729; color:#eaf2ff; border:1px solid #203153;
      padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      z-index:4000; display:none; font-weight:600; max-width:90vw; text-align:center;
    }
  </style>
</head>
<body>
  <header>
    <h1>Captura de Brechas</h1>
    <span class="muted">Single HTML ‚Ä¢ Offline (IDB) ‚Ä¢ GPS ‚Ä¢ Fotos</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="pendingBadge" class="chip" style="display:none"></span>
      <button id="syncBtn" class="btn btn-ghost" style="padding:8px 10px">üîÑ Sincronizar</button>
    </div>
  </header>

  <div id="net">Est√°s sin conexi√≥n. Puedes seguir capturando; sincronizaremos cuando vuelva el internet.</div>
  <div id="map"></div>
  <div id="pendingBanner" class="pending-banner">Tienes <strong id="pendingCount">0</strong> reporte(s) pendientes de sincronizar.</div>

  <!-- Floating Action -->
  <button id="newTramo" class="fab">+ Nuevo tramo</button>

  <!-- Bottom Sheet / Stepper -->
  <section id="sheet" class="sheet" aria-modal="true" role="dialog">
    <div class="drag"></div>
    <div class="content">
      <div id="step-1" class="grid">
        <div class="card">
          <div class="chips" style="margin-bottom:8px">
            <span class="chip"><span class="color-box apertura"></span>Apertura</span>
            <span class="chip"><span class="color-box limpieza"></span>Limpieza</span>
          </div>
          <div class="row">
            <div class="field">
              <label>Sector</label>
              <input id="sector" type="text" placeholder="Ej: Norte">
            </div>
            <div class="field">
              <label>Subestaci√≥n</label>
              <input id="subestacion" type="text" placeholder="Ej: S/E Progreso">
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Circuito</label>
              <input id="circuito" type="text" placeholder="Ej: CIR-123">
            </div>
            <div class="field">
              <label>Tipo de brecha</label>
              <select id="tipo">
                <option value="Apertura">Apertura de brecha</option>
                <option value="Limpieza">Limpieza de brecha</option>
              </select>
            </div>
          </div>
          <div class="note">Completa y pulsa <strong>Siguiente</strong>.</div>
          <div class="bar" style="margin-top:10px">
            <button id="s1-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s1-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-2" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 2:</strong> Capturar <u>punto inicial</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-inicio" class="btn btn-primary">Captar punto inicial (GPS)</button>
          <div class="field">
            <label>Foto punto inicial (requerida)</label>
            <input id="fotoInicio" type="file" accept="image/*" capture="environment">
          </div>
          <div id="previewInicioWrap" class="hidden">
            <img id="previewInicio" class="preview" alt="Foto inicio"/>
          </div>
          <div class="bar">
            <button id="s2-back" class="btn btn-ghost">Atr√°s</button>
            <button id="s2-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-3" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 3:</strong> Capturar <u>punto final</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-fin" class="btn btn-primary">Captar punto final (GPS)</button>
          <div class="field">
            <label>Foto punto final (requerida)</label>
            <input id="fotoFin" type="file" accept="image/*" capture="environment">
          </div>
          <div id="previewFinWrap" class="hidden">
            <img id="previewFin" class="preview" alt="Foto final"/>
          </div>
          <div class="bar">
            <button id="s3-back" class="btn btn-ghost">Atr√°s</button>
            <button id="s3-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-4" class="grid hidden">
        <div class="card grid">
          <div><strong>Resumen</strong> ‚Äî revisa y guarda.</div>
          <div id="resumen" class="grid"></div>
          <div class="bar">
            <button id="s4-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s4-save" class="btn btn-ok">Guardar tramo</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
  "use strict";

  // ===== CONFIG (usa tus proxys/endpoints) =====
  const APPS_SCRIPT_URL = "/api/sync"; // Ajusta a tu proxy/endpoint actual

  // ===== Estado de red =====
  const netBar = document.getElementById('net');
  function updateNetUI(){
    if (navigator.onLine) { netBar.style.display = 'none'; }
    else { netBar.style.display = 'block'; }
  }
  window.addEventListener('online', function(){ updateNetUI(); attemptSync(); });
  window.addEventListener('offline', updateNetUI);
  updateNetUI();

  // ====== Carga din√°mica Leaflet ======
  let L_loaded = false;
  function loadLeaflet() {
    return new Promise(function(resolve){
      if (window.L) { L_loaded = true; return resolve(true); }
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      s.async = true;
      s.onload = function(){ L_loaded = true; resolve(true); };
      s.onerror = function(){ resolve(false); };
      document.head.appendChild(s);
      setTimeout(function(){ if (!window.L) resolve(false); }, 5000);
    });
  }

  // ====== Mapa ======
  let map = null;
  let mapLayers = [];
  function initMapIfAvailable(){
    if (!L_loaded || !window.L) return;
    try {
      map = L.map('map', { zoomControl: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      map.setView([14.0723,-87.1921], 7);
    } catch (e) {
      console.warn('No se pudo iniciar Leaflet:', e);
    }
  }

  loadLeaflet().then(function(){ initMapIfAvailable(); locate(); renderAll(); });

  function addLayer(layer){
    mapLayers.push(layer);
    if (map) { layer.addTo(map); }
  }
  function clearMapLayers(){
    mapLayers.forEach(function(l){
      try{ if(map) map.removeLayer(l); }catch(_){}
    });
    mapLayers = [];
  }

  // ====== Utiles DOM ======
  const $ = function(id){ return document.getElementById(id); };
  const sheet = $("sheet");
  let step = 1;

  function openSheet(){ sheet.classList.add("open"); }
  function closeSheet(){ sheet.classList.remove("open"); setStep(1); clearWizard(false); }
  function show(id){ var el = $(id); if(el) el.classList.remove("hidden"); }
  function hide(id){ var el = $(id); if(el) el.classList.add("hidden"); }
  function setStep(n){
    step = n;
    ["step-1","step-2","step-3","step-4"].forEach(function(s){ hide(s); });
    show("step-"+n);
  }
  function tipoColor(t){ return (t==="Limpieza") ? "#22c55e" : "#f97316"; }

  // ====== Geolocalizaci√≥n r√°pida ======
  function getGPSFast(){
    return new Promise(function(resolve,reject){
      if(!navigator.geolocation) return reject(new Error("Geolocalizaci√≥n no disponible"));
      let done = false;
      const opts = { enableHighAccuracy:true, timeout:15000, maximumAge:30000 };
      const id = navigator.geolocation.watchPosition(function(pos){
        if(done) return;
        done = true;
        try{ navigator.geolocation.clearWatch(id); }catch(_){}
        resolve({ lat:pos.coords.latitude, lng:pos.coords.longitude, ts:Date.now(), acc:pos.coords.accuracy });
      }, function(err){
        if(done) return;
        done = true;
        try{ navigator.geolocation.clearWatch(id); }catch(_){}
        reject(err);
      }, opts);
      setTimeout(function(){
        if(!done){
          done = true;
          try{ navigator.geolocation.clearWatch(id); }catch(_){}
          reject(new Error('timeout'));
        }
      }, 16000);
    });
  }

  function locate() {
    if (!map) return;
    if (navigator.geolocation) {
      showBlocker('Obteniendo ubicaci√≥n‚Ä¶');
      getGPSFast().then(function(p){
        hideBlocker();
        map.setView([p.lat, p.lng], 17);
      }).catch(function(){
        hideBlocker();
      });
    }
  }

  // ====== Imagen ======
  function canvasToBlob(canvas, type, quality){
    return new Promise(function(resolve){
      canvas.toBlob(function(blob){ resolve(blob); }, type, quality);
    });
  }
  async function compressToBlob(file, maxW, maxH, quality){
    if(!file) return null;
    const img = await new Promise(function(res,rej){
      const reader = new FileReader();
      reader.onload = function(){
        const i = new Image();
        i.onload = function(){ res(i); };
        i.onerror = rej;
        i.src = reader.result;
      };
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
    const w = Math.round(img.width * ratio);
    const h = Math.round(img.height * ratio);
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha:false });
    ctx.drawImage(img, 0, 0, w, h);
    return await canvasToBlob(canvas, 'image/jpeg', quality);
  }
  function blobToObjectURL(blob){ try{ return URL.createObjectURL(blob); }catch(_){ return null; } }
  function blobToDataURL(blob){ return new Promise(function(res, rej){
    const fr = new FileReader();
    fr.onload = function(){ res(fr.result); };
    fr.onerror = rej;
    fr.readAsDataURL(blob);
  }); }

  // ====== IndexedDB ======
  const DB_NAME = 'brechas-db';
  const DB_VER = 1;
  function openDB(){
    return new Promise(function(resolve, reject){
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = function(e){
        const db = e.target.result;
        if(!db.objectStoreNames.contains('items')){
          const s = db.createObjectStore('items', { keyPath: 'id' });
          s.createIndex('synced', 'synced', { unique:false });
        }
        if(!db.objectStoreNames.contains('photos')){
          db.createObjectStore('photos', { keyPath: 'key' });
        }
      };
      req.onsuccess = function(){ resolve(req.result); };
      req.onerror = function(){ reject(req.error); };
    });
  }
  async function dbTx(store, mode, fn){
    const db = await openDB();
    return new Promise(function(resolve, reject){
      const tx = db.transaction(store, mode);
      const st = tx.objectStore(store);
      const ret = fn(st);
      tx.oncomplete = function(){ resolve(ret); };
      tx.onerror = function(){ reject(tx.error); };
    });
  }
  function putItem(item){ return dbTx('items', 'readwrite', function(st){ st.put(item); }); }
  // FIX: getAllItems debe resolver con array real, no con IDBRequest
  function getAllItems(){
    return new Promise(async function(resolve, reject){
      try {
        const db = await openDB();
        const tx = db.transaction('items','readonly');
        const st = tx.objectStore('items');
        const req = st.getAll();
        req.onsuccess = function(){ resolve(req.result || []); };
        req.onerror = function(){ reject(req.error); };
      } catch (e) { reject(e); }
    });
  }
  function updateItem(id, patch){
    return dbTx('items','readwrite', function(st){
      const req = st.get(id);
      req.onsuccess = function(){
        const it = req.result || { id:id };
        Object.assign(it, patch);
        st.put(it);
      };
    });
  }
  function putPhoto(key, blob){ return dbTx('photos','readwrite', function(st){ st.put({ key:key, blob:blob }); }); }
  function getPhoto(key){
    return new Promise(async function(resolve, reject){
      const db = await openDB();
      const tx = db.transaction('photos','readonly');
      const st = tx.objectStore('photos');
      const req = st.get(key);
      req.onsuccess = function(){ resolve(req.result ? req.result.blob : null); };
      req.onerror = function(){ reject(req.error); };
    });
  }

  // ====== App State ======
  const state = {
    actual: {
      sector:"", subestacion:"", circuito:"", tipo:"Apertura",
      inicio:null, fin:null, fotoInicioKey:null, fotoFinKey:null
    },
    items: [],
    tempMkIni:null, tempMkFin:null
  };

  function markerPopupHtml(p, titulo, fotoUrl, meta){
    var imgHtml = fotoUrl
      ? '<img class="popup-img" src="' + fotoUrl + '" alt="foto"/>'
      : '<div class="popup-meta">Sin foto</div>';
    return (
      '<div style="min-width:220px">'
      + '<div class="popup-title">' + titulo + '</div>'
      + '<div class="popup-meta">Lat: ' + p.lat.toFixed(6) + ' ¬∑ Lng: ' + p.lng.toFixed(6) + (p.acc ? ' ‚Ä¢ ¬±' + Math.round(p.acc) + 'm' : '') + '</div>'
      + '<div class="popup-meta">' + meta + '</div>'
      + imgHtml
      + '</div>'
    );
  }

  async function drawItem(it, fit){
    const col = (it && it.tipo === "Limpieza") ? "#22c55e" : "#f97316";
    if (map && window.L && it && it.inicio && it.fin) {
      var line = L.polyline(
        [
          [it.inicio.lat, it.inicio.lng],
          [it.fin.lat, it.fin.lng]
        ],
        { color: col, weight: 5, opacity: 0.95 }
      );
      addLayer(line);

      let urlIni = null, urlFin = null;
      try{
        if (it.fotoInicioKey){ const b1 = await getPhoto(it.fotoInicioKey); if(b1) urlIni = blobToObjectURL(b1); }
        if (it.fotoFinKey){ const b2 = await getPhoto(it.fotoFinKey); if(b2) urlFin = blobToObjectURL(b2); }
      }catch(_){}

      var mkIni = L.circleMarker([it.inicio.lat, it.inicio.lng], { radius:7, color:col, fillColor:col, fillOpacity:0.95 });
      mkIni.bindPopup(function(){
        return markerPopupHtml(it.inicio, 'INICIO ‚Äî ' + it.circuito, urlIni, it.sector + ' ‚Ä¢ ' + it.subestacion + ' ‚Ä¢ ' + it.tipo);
      });
      addLayer(mkIni);

      var mkFin = L.circleMarker([it.fin.lat, it.fin.lng], { radius:7, color:col, fillColor:col, fillOpacity:0.95 });
      mkFin.bindPopup(function(){
        return markerPopupHtml(it.fin, 'FINAL ‚Äî ' + it.circuito, urlFin, it.sector + ' ‚Ä¢ ' + it.subestacion + ' ‚Ä¢ ' + it.tipo);
      });
      addLayer(mkFin);

      line.on("click", async function(){
        var mid = [(it.inicio.lat + it.fin.lat)/2, (it.inicio.lng + it.fin.lng)/2];
        let urlIni2 = urlIni, urlFin2 = urlFin;
        if (!urlIni2 && it.fotoInicioKey){ const b = await getPhoto(it.fotoInicioKey); if(b) urlIni2 = blobToObjectURL(b); }
        if (!urlFin2 && it.fotoFinKey){ const b = await getPhoto(it.fotoFinKey); if(b) urlFin2 = blobToObjectURL(b); }
        var html = ''
          + '<div style="min-width:240px">'
          +   '<div class="popup-title">' + it.sector + ' ‚Ä¢ ' + it.subestacion + '</div>'
          +   '<div class="popup-meta">Circuito: <b>' + it.circuito + '</b> ‚Äî <span style="color:' + col + '">' + it.tipo + '</span></div>'
          +   '<div class="popup-meta">' + new Date(it.createdAt).toLocaleString() + '</div>'
          +   '<div class="popup-meta">Inicio: ' + it.inicio.lat.toFixed(6) + ', ' + it.inicio.lng.toFixed(6) + '</div>'
          +   '<div class="popup-meta">Final: ' + it.fin.lat.toFixed(6) + ', ' + it.fin.lng.toFixed(6) + '</div>'
          +   (urlIni2 ? '<div style="margin-top:6px">Foto inicio:</div><img class="popup-img" src="' + urlIni2 + '"/>' : '')
          +   (urlFin2 ? '<div style="margin-top:6px">Foto final:</div><img class="popup-img" src="' + urlFin2 + '"/>' : '')
          + '</div>';
        L.popup().setLatLng(mid).setContent(html).openOn(map);
      });

      if (fit){
        var b = L.latLngBounds([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]]);
        map.fitBounds(b.pad(0.3));
      }
    }
  }

  async function renderAll(){
    clearMapLayers();
    let items = [];
    try { items = await getAllItems(); } catch(e){ items = []; }
    if (!Array.isArray(items)) items = [];
    state.items = items;
    // Guard contra sort si no es funci√≥n
    if (Array.isArray(state.items)) {
      state.items.sort(function(a,b){ return String(a.createdAt||'').localeCompare(String(b.createdAt||'')); });
      for (let i=0;i<state.items.length;i++){ await drawItem(state.items[i], false); }
    }
    updatePendingUI();
  }

  function clearWizard(resetAll){
    if (typeof resetAll === "undefined") resetAll = true;
    if(resetAll){
      state.actual = { sector:"", subestacion:"", circuito:"", tipo:"Apertura", inicio:null, fin:null, fotoInicioKey:null, fotoFinKey:null };
    } else {
      state.actual.inicio = null; state.actual.fin = null; state.actual.fotoInicioKey = null; state.actual.fotoFinKey = null;
    }
    $("sector").value = ""; $("subestacion").value=""; $("circuito").value="";
    $("tipo").value = "Apertura";
    $("fotoInicio").value = ""; $("fotoFin").value = "";
    $("previewInicioWrap").classList.add("hidden");
    $("previewFinWrap").classList.add("hidden");
    $("previewInicio").src = ""; $("previewFin").src = "";
  }

  function validateStep1(){
    var sector = $("sector").value.trim();
    var sub = $("subestacion").value.trim();
    var circ = $("circuito").value.trim();
    if(!sector || !sub || !circ) return false;
    state.actual.sector = sector; state.actual.subestacion = sub; state.actual.circuito = circ;
    state.actual.tipo = $("tipo").value;
    return true;
  }

  async function capInicio(){
    showBlocker('Obteniendo GPS (inicio)‚Ä¶');
    try{
      const p = await getGPSFast();
      state.actual.inicio = p;
      if (state.tempMkIni && map) { try { map.removeLayer(state.tempMkIni); } catch(_){ } }
      if (map && window.L) {
        const mk = L.marker([p.lat,p.lng], { title:"Inicio (ajustable)", draggable:true }).bindPopup("Arrastra para ajustar inicio");
        mk.on("dragend", function(e){
          const ll = e.target.getLatLng();
          state.actual.inicio = { lat: ll.lat, lng: ll.lng, ts: Date.now() };
        });
        addLayer(mk);
        state.tempMkIni = mk;
        mk.openPopup();
      }
      toast('Punto inicial capturado.');
    } finally { hideBlocker(); }
  }

  async function capFin(){
    showBlocker('Obteniendo GPS (final)‚Ä¶');
    try{
      const p = await getGPSFast();
      state.actual.fin = p;
      if (state.tempMkFin && map) { try { map.removeLayer(state.tempMkFin); } catch(_){ } }
      if (map && window.L) {
        const mk = L.marker([p.lat,p.lng], { title:"Final (ajustable)", draggable:true }).bindPopup("Arrastra para ajustar final");
        mk.on("dragend", function(e){
          const ll = e.target.getLatLng();
          state.actual.fin = { lat: ll.lat, lng: ll.lng, ts: Date.now() };
        });
        addLayer(mk);
        state.tempMkFin = mk;
        mk.openPopup();
      }
      toast('Punto final capturado.');
    } finally { hideBlocker(); }
  }

  async function validateStep2(){
    if(!state.actual.inicio){
      try { await capInicio(); } catch (e) {}
    }
    var f = $("fotoInicio").files[0];
    if(!state.actual.inicio || !f) return false;
    const blob = await compressToBlob(f, 1280, 1280, 0.72);
    const key = 'f-' + (Date.now()) + '-' + Math.random().toString(16).slice(2) + '-ini';
    await putPhoto(key, blob);
    state.actual.fotoInicioKey = key;
    const thumb = await compressToBlob(f, 960, 960, 0.7);
    $("previewInicio").src = blobToObjectURL(thumb);
    $("previewInicioWrap").classList.remove("hidden");
    return true;
  }

  async function validateStep3(){
    if(!state.actual.fin){
      try { await capFin(); } catch (e) {}
    }
    var f = $("fotoFin").files[0];
    if(!state.actual.fin || !f) return false;
    const blob = await compressToBlob(f, 1280, 1280, 0.72);
    const key = 'f-' + (Date.now()) + '-' + Math.random().toString(16).slice(2) + '-fin';
    await putPhoto(key, blob);
    state.actual.fotoFinKey = key;
    const thumb = await compressToBlob(f, 960, 960, 0.7);
    $("previewFin").src = blobToObjectURL(thumb);
    $("previewFinWrap").classList.remove("hidden");
    return true;
  }

  function fillResumen(){
    var it = state.actual;
    var col = (it.tipo === "Limpieza") ? "#22c55e" : "#f97316";
    $("resumen").innerHTML =
      '<div class="grid">'
      + '<div><b>Sector:</b> ' + it.sector + '</div>'
      + '<div><b>Subestaci√≥n:</b> ' + it.subestacion + '</div>'
      + '<div><b>Circuito:</b> ' + it.circuito + '</div>'
      + '<div><b>Tipo:</b> <span style="color:' + col + '">' + it.tipo + '</span></div>'
      + '<div><b>Inicio:</b> ' + (it.inicio ? it.inicio.lat.toFixed(6)+', '+it.inicio.lng.toFixed(6) : '-') + '</div>'
      + '<div><b>Final:</b> ' + (it.fin ? it.fin.lat.toFixed(6)+', '+it.fin.lng.toFixed(6) : '-') + '</div>'
      + '<div><b>Foto inicio:</b> clave ' + (it.fotoInicioKey || '-') + '</div>'
      + '<div><b>Foto final:</b> clave ' + (it.fotoFinKey || '-') + '</div>'
      + '</div>';
  }

  async function fetchJSON(url, payload, opts){
    const options = opts || {};
    const timeoutMs = options.timeoutMs || 15000;
    const retries = options.retries != null ? options.retries : 1;
    const ctrl = new AbortController();
    const t = setTimeout(function(){ try{ ctrl.abort(); }catch(_){ } }, timeoutMs);
    try{
      const res = await fetch(url, Object.assign({}, payload, { signal: ctrl.signal }));
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }catch(e){
      if(retries>0) return fetchJSON(url, payload, {timeoutMs:timeoutMs, retries:retries-1});
      throw e;
    }finally{ clearTimeout(t); }
  }

  async function syncItems(items){
    if(!APPS_SCRIPT_URL) return { ok:false, error:"Sin URL" };
    const payloadRecords = [];
    for (let i=0;i<items.length;i++){
      const x = items[i];
      let fotoInicio64 = null, fotoFin64 = null;
      try{ if (x.fotoInicioKey){ const b = await getPhoto(x.fotoInicioKey); if(b) fotoInicio64 = await blobToDataURL(b); } }catch(_){}
      try{ if (x.fotoFinKey){ const b = await getPhoto(x.fotoFinKey); if(b) fotoFin64 = await blobToDataURL(b); } }catch(_){}
      payloadRecords.push({
        id: x.id, sector: x.sector, subestacion: x.subestacion, circuito: x.circuito,
        tipo: x.tipo, inicio: x.inicio, fin: x.fin, createdAt: x.createdAt,
        fotoInicio: fotoInicio64, fotoFin: fotoFin64
      });
    }
    return await fetchJSON(APPS_SCRIPT_URL, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({records: payloadRecords})
    }, { timeoutMs: 20000, retries: 1 });
  }

  async function attemptSync(){
    try{
      const items = await getAllItems();
      const pend = (Array.isArray(items) ? items : []).filter(function(it){ return !it.synced; });
      if (!pend.length) return;
      const data = await syncItems(pend);
      const okIds = new Set([].concat(data.syncedIds || [], data.alreadySyncedIds || []));
      for (let i=0;i<pend.length;i++){
        const it = pend[i];
        if (okIds.has(it.id)) await updateItem(it.id, { synced:true });
      }
      await renderAll();
      toast('‚úÖ Sincronizaci√≥n completa');
    } catch (e) {
      console.warn('Sync fall√≥:', e);
    }
  }

  function getPendingCountLocal(){ try{ return (state.items || []).filter(function(it){ return !it.synced; }).length; }catch(_){ return 0; } }
  function updatePendingUI(){
    const n = getPendingCountLocal();
    const badge = document.getElementById("pendingBadge");
    const banner = document.getElementById("pendingBanner");
    const countEl = document.getElementById("pendingCount");
    if(badge){
      if(n>0){ badge.style.display='inline-block'; badge.textContent = n + ' pendiente(s)'; }
      else { badge.style.display='none'; }
    }
    if(banner){
      if(n>0){ banner.style.display='block'; if(countEl) countEl.textContent = n; }
      else { banner.style.display='none'; }
    }
  }

  // ====== Eventos UI ======
  $("newTramo").onclick = function(){ openSheet(); setStep(1); };
  $("s1-cancel").onclick = closeSheet;
  $("s1-next").onclick = function(){
    if(!validateStep1()){ toast("Completa Sector, Subestaci√≥n y Circuito."); return; }
    setStep(2);
  };
  $("s2-back").onclick = function(){ setStep(1); };
  $("s2-next").onclick = async function(){
    const ok = await validateStep2();
    if(!ok){ toast("Captura el punto inicial y selecciona una foto."); return; }
    setStep(3);
  };
  $("s3-back").onclick = function(){ setStep(2); };
  $("s3-next").onclick = async function(){
    const ok = await validateStep3();
    if(!ok){ toast("Captura el punto final y selecciona una foto."); return; }
    fillResumen();
    setStep(4);
  };
  $("s4-cancel").onclick = function(){ closeSheet(); };

  $("s4-save").onclick = async function(){
    const btn = $("s4-save"); btn.disabled = true;
    const it = {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + '-' + Math.random().toString(16).slice(2),
      sector: state.actual.sector,
      subestacion: state.actual.subestacion,
      circuito: state.actual.circuito,
      tipo: state.actual.tipo,
      inicio: state.actual.inicio,
      fin: state.actual.fin,
      fotoInicioKey: state.actual.fotoInicioKey,
      fotoFinKey: state.actual.fotoFinKey,
      createdAt: new Date().toISOString(),
      synced: false
    };
    await putItem(it);
    closeSheet();

    try{ if(state.tempMkIni && map){ map.removeLayer(state.tempMkIni); state.tempMkIni=null; } }catch(_){}
    try{ if(state.tempMkFin && map){ map.removeLayer(state.tempMkFin); state.tempMkFin=null; } }catch(_){}

    await renderAll();
    updatePendingUI();

    showBlocker('Guardando' + (navigator.onLine ? ' y sincronizando‚Ä¶' : '‚Ä¶'));
    let ok = false;
    try {
      if (navigator.onLine) { await attemptSync(); ok = true; }
    } catch (e) { /* pendiente */ }
    hideBlocker();
    toast(ok ? "Informaci√≥n guardada correctamente" : "Guardado local OK, sincronizaci√≥n pendiente.");
    btn.disabled = false;
  };

  $("cap-inicio").onclick = capInicio;
  $("cap-fin").onclick = capFin;

  $("fotoInicio").addEventListener("change", async function(e){
    if(e.target.files[0]){
      const thumb = await compressToBlob(e.target.files[0], 960, 960, 0.7);
      $("previewInicio").src = blobToObjectURL(thumb); $("previewInicioWrap").classList.remove("hidden");
    }
  });
  $("fotoFin").addEventListener("change", async function(e){
    if(e.target.files[0]){
      const thumb = await compressToBlob(e.target.files[0], 960, 960, 0.7);
      $("previewFin").src = blobToObjectURL(thumb); $("previewFinWrap").classList.remove("hidden");
    }
  });

  document.addEventListener('click', function(e){
    const el = e.target;
    if (el && el.classList && el.classList.contains('preview')) {
      try { window.open(el.src, '_blank'); } catch(_) {}
    }
  });

  const syncBtn = document.getElementById("syncBtn");
  if(syncBtn){
    syncBtn.addEventListener("click", async function(){
      const n = getPendingCountLocal();
      if(n===0){ toast("No hay reportes pendientes."); return; }
      showBlocker('Sincronizando‚Ä¶');
      try{ await attemptSync(); } finally { hideBlocker(); }
    });
  }

  // ====== UI helpers ======
  function toast(msg){
    let t = document.getElementById('toast');
    if(!t){ t = document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(function(){ t.style.display='none'; }, 3000);
  }
  function showBlocker(text){
    const el = document.getElementById('blocker');
    const tx = document.getElementById('blockerText');
    if(tx) tx.textContent = text || 'Procesando‚Ä¶';
    if(el) el.style.display = 'flex';
  }
  function hideBlocker(){
    const el = document.getElementById('blocker');
    if(el) el.style.display = 'none';
  }

  // IMPORTANTE: sin archivos extra no podemos registrar ServiceWorker v√≠a blob: en producci√≥n.
  // Por eso, en esta versi√≥n v2 NO registramos SW. 
  // Offline persiste datos/fotos en IndexedDB y puedes seguir trabajando con la pesta√±a abierta.
  // Si en el futuro aceptas un archivo sw.js en el root, reactivamos PWA completa sin tocar el resto.

  (async function(){ await renderAll(); })();
  </script>

  <div id="blocker" class="blocker" aria-hidden="true">
    <div class="box"><span class="spinner"></span><span id="blockerText">Guardando‚Ä¶</span></div>
  </div>
</body>
</html>
