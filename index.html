// ===== CONFIG =====
var SHEET_ID   = '1K22CCUhfzU7pvM9nUHEt6oYPn6LRQ24X0FMBBIfzc0k';
var SHEET_NAME = 'Hoja 1';            // hoja donde se guardan los tramos
var FOLDER_ID  = '150Lz2UP2muETfRA_KYhbAG7xRy7Nz2hb'; // carpeta para fotos
var SHEET_CATALOG_NAME = 'Hoja 2';    // hoja con SUBESTACION | SECTOR | CIRCUITO

// ===== HELPERS =====
function ensureSheet_() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sh = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
  if (sh.getLastRow() === 0) {
    sh.appendRow([
      'SECTOR','SUBESTACION','CIRCUITO','TIPO BRECHA',
      'PUNTO INICIAL','PUNTO FINAL',
      'FOTO INICIO URL','FOTO FIN URL',
      'CREATED_AT','ID'
    ]);
  }
  return sh;
}

/**
 * Guarda una imagen base64 en Drive y devuelve su URL publica embebible (uc?export=view&id=).
 */
function saveImageToDrive_(base64, filename) {
  if (!base64) return '';
  var parts = String(base64).split(',');
  var data = parts.length > 1 ? parts[1] : parts[0];
  var bytes = Utilities.base64Decode(data);

  var contentType = 'image/jpeg';
  if (parts[0] && parts[0].indexOf('image/png') !== -1) contentType = 'image/png';

  var blob = Utilities.newBlob(bytes, contentType, filename);
  var folder = DriveApp.getFolderById(FOLDER_ID);
  var file = folder.createFile(blob);

  // Compartir por enlace (si el dominio lo permite)
  try { file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch (e) {}

  // Igual devolvemos la URL uc por compatibilidad
  return 'https://drive.google.com/uc?export=view&id=' + file.getId();
}

function jsonOut_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Lee todas las filas y devuelve un arreglo de objetos.
 * Coordenadas como "lat,lng" para payload mas chico.
 */
function readAllRecords_() {
  var sh = ensureSheet_();
  var lastRow = sh.getLastRow();
  var lastCol = sh.getLastColumn();

  var COL_SECTOR = 1, COL_SUB = 2, COL_CIRC = 3, COL_TIPO = 4,
      COL_PINI = 5, COL_PFIN = 6, COL_FINI = 7, COL_FFIN = 8,
      COL_CREATED = 9, COL_ID = 10;

  var records = [];
  if (lastRow >= 2) {
    var rows = sh.getRange(2, 1, lastRow - 1, lastCol).getValues();
    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      records.push({
        sector: String(r[COL_SECTOR - 1] || ''),
        subestacion: String(r[COL_SUB - 1] || ''),
        circuito: String(r[COL_CIRC - 1] || ''),
        tipo: String(r[COL_TIPO - 1] || ''),
        inicio: String(r[COL_PINI - 1] || ''),
        fin: String(r[COL_PFIN - 1] || ''),
        fotoInicioUrl: String(r[COL_FINI - 1] || ''),
        fotoFinUrl: String(r[COL_FFIN - 1] || ''),
        createdAt: String(r[COL_CREATED - 1] || ''),
        id: String(r[COL_ID - 1] || '')
      });
    }
  }
  return records;
}

// ===== CATÁLOGO DESDE "Hoja 2" =====
/**
 * Lee Hoja 2 en formato columnas: A=SUBESTACION, B=SECTOR, C=CIRCUITO (con encabezados).
 * Devuelve { sectors: string[], bySector: {sector: string[]}, bySubestacion: {sub: string[]} }.
 */
function readCatalog_() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sh = ss.getSheetByName(SHEET_CATALOG_NAME);
  if (!sh) return { sectors: [], bySector: {}, bySubestacion: {} };

  var lastRow = sh.getLastRow();
  var lastCol = sh.getLastColumn();
  if (lastRow < 2 || lastCol < 3) return { sectors: [], bySector: {}, bySubestacion: {} };

  // Tomamos todo (asumimos encabezados en la fila 1)
  var values = sh.getRange(1, 1, lastRow, 3).getValues();

  var sectorsSet = {};
  var bySector = {};         // sector -> [subestaciones]
  var bySubestacion = {};    // subestacion -> [circuitos]

  for (var i = 1; i < values.length; i++) { // desde la fila 2
    var sub = String(values[i][0] || '').trim(); // A
    var sec = String(values[i][1] || '').trim(); // B
    var cir = String(values[i][2] || '').trim(); // C
    if (!sec && !sub && !cir) continue;

    if (sec) sectorsSet[sec] = true;

    if (sec && sub) {
      if (!bySector[sec]) bySector[sec] = [];
      if (bySector[sec].indexOf(sub) === -1) bySector[sec].push(sub);
    }

    if (sub && cir) {
      if (!bySubestacion[sub]) bySubestacion[sub] = [];
      if (bySubestacion[sub].indexOf(cir) === -1) bySubestacion[sub].push(cir);
    }
  }

  var sectors = Object.keys(sectorsSet).sort();
  Object.keys(bySector).forEach(function(k){ bySector[k].sort(); });
  Object.keys(bySubestacion).forEach(function(k){ bySubestacion[k].sort(); });

  return { sectors: sectors, bySector: bySector, bySubestacion: bySubestacion };
}

// ===== ENDPOINTS =====
function doGet(e) {
  try {
    var mode = e && e.parameter && e.parameter.mode;

    // Devolver todos los registros
    if (mode === 'all') {
      var records = readAllRecords_();
      return jsonOut_({ ok: true, records: records });
    }

    // Devolver catálogo para selects (Hoja 2)
    if (mode === 'options') {
      var cat = readCatalog_();
      return jsonOut_({ ok: true, sectors: cat.sectors, bySector: cat.bySector, bySubestacion: cat.bySubestacion, updatedAt: new Date().toISOString() });
    }

    // Ping por defecto
    return jsonOut_({ ok: true, ping: 'pong', when: new Date().toISOString() });
  } catch (err) {
    return jsonOut_({ ok: false, error: String(err) });
  }
}

function doPost(e) {
  try {
    var raw = (e && e.postData && e.postData.contents) ? e.postData.contents : '{}';
    var body = JSON.parse(raw);
    var records = Object.prototype.toString.call(body.records) === '[object Array]' ? body.records : [];

    var sh = ensureSheet_();
    var lastRow = sh.getLastRow();
    var lastCol = sh.getLastColumn();

    var COL_SECTOR = 1, COL_SUB = 2, COL_CIRC = 3, COL_TIPO = 4,
        COL_PINI = 5, COL_PFIN = 6, COL_FINI = 7, COL_FFIN = 8,
        COL_CREATED = 9, COL_ID = 10;

    // Mapear IDs existentes
    var idMap = {}; // id -> row
    if (lastRow >= 2) {
      var existing = sh.getRange(2, 1, lastRow - 1, lastCol).getValues();
      for (var i = 0; i < existing.length; i++) {
        var rowIndex = i + 2;
        var id = String(existing[i][COL_ID - 1] || '').trim();
        if (id) idMap[id] = rowIndex;
      }
    }

    var syncedIds = [];
    var alreadySyncedIds = [];
    var urlMap = {}; // id -> {inicio, fin}
    var rowsToAppend = [];

    for (var j = 0; j < records.length; j++) {
      var r = records[j];
      var idr = r.id || Utilities.getUuid();
      var existsRow = idMap[idr] || 0;

      var pIni = r.inicio ? (r.inicio.lat + ',' + r.inicio.lng) : '';
      var pFin = r.fin ? (r.fin.lat + ',' + r.fin.lng) : '';

      var fotoIniUrl = '';
      var fotoFinUrl = '';

      if (r.fotoInicio) fotoIniUrl = saveImageToDrive_(r.fotoInicio, idr + '_inicio.jpg');
      if (r.fotoFin)    fotoFinUrl = saveImageToDrive_(r.fotoFin, idr + '_fin.jpg');

      if (existsRow) {
        // Actualiza las fotos si llegaron nuevas
        if (fotoIniUrl) sh.getRange(existsRow, COL_FINI).setValue(fotoIniUrl);
        if (fotoFinUrl) sh.getRange(existsRow, COL_FFIN).setValue(fotoFinUrl);

        // Mantiene URLs anteriores si no llegaron nuevas
        if (!fotoIniUrl) fotoIniUrl = String(sh.getRange(existsRow, COL_FINI).getValue() || '');
        if (!fotoFinUrl) fotoFinUrl = String(sh.getRange(existsRow, COL_FFIN).getValue() || '');

        // No tocamos otras columnas en update parcial
        urlMap[idr] = { inicio: fotoIniUrl, fin: fotoFinUrl };
        alreadySyncedIds.push(idr);
      } else {
        rowsToAppend.push([
          r.sector || '',
          r.subestacion || '',
          r.circuito || '',
          r.tipo || '',
          pIni,
          pFin,
          fotoIniUrl,
          fotoFinUrl,
          r.createdAt || new Date().toISOString(),
          idr
        ]);
        urlMap[idr] = { inicio: fotoIniUrl, fin: fotoFinUrl };
        syncedIds.push(idr);
      }
    }

    if (rowsToAppend.length) {
      sh.getRange(sh.getLastRow() + 1, 1, rowsToAppend.length, lastCol).setValues(rowsToAppend);
    }

    return jsonOut_({ ok: true, syncedIds: syncedIds, alreadySyncedIds: alreadySyncedIds, urlMap: urlMap });
  } catch (err) {
    return jsonOut_({ ok: false, error: String(err) });
  }
}
