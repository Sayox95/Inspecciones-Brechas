<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="icon" href="data:,"/>
  <title>Captura de Brechas ‚Äî Versi√≥n Limpia</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>

/* Transiciones profesionales entre pasos (direcci√≥n-aware) */
.step{opacity:0;transform:translateX(0)}
.step.active{opacity:1}

/* Animaciones: entradas/salidas con deslizamiento + ligera elevaci√≥n */
@keyframes slideInFromRight{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideOutToLeft{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-28px)}}
@keyframes slideInFromLeft{from{opacity:0;transform:translateX(-28px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideOutToRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(28px)}}

/* Clases utilitarias */
.anim-enter-left{animation:slideInFromRight .34s cubic-bezier(.22,1,.36,1)}
.anim-exit-left{animation:slideOutToLeft .30s cubic-bezier(.4,0,.2,1)}
.anim-enter-right{animation:slideInFromLeft .34s cubic-bezier(.22,1,.36,1)}
.anim-exit-right{animation:slideOutToRight .30s cubic-bezier(.4,0,.2,1)}

/* Respeta usuarios con reduce motion */
@media (prefers-reduced-motion: reduce){
  .anim-enter-left,.anim-exit-left,.anim-enter-right,.anim-exit-right{animation:none}
}


.btn:disabled{opacity:.75;cursor:not-allowed}

    
/* --- Spinner en botones --- */
.btn.loading { position: relative; pointer-events: none; opacity: .85; }
.btn .spinner {
  display: inline-block; width: 1em; height: 1em; vertical-align: -2px;
  border: .18em solid currentColor; border-right-color: transparent; border-radius: 50%;
  margin-right: .5em; animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

:root{--bg:#0b1220;--card:#0f182a;--muted:#8aa0b6;--text:#ecf3ff;--accent:#4cc9f0;--ok:#22c55e;--warn:#f97316;--danger:#ef4444;--border:#1d2a45;--sheet:#0b1220;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text);overflow:hidden;-webkit-tap-highlight-color:transparent}
    header{position:fixed;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:10px;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:12px 14px}
    header h1{margin:0;font-size:16px} header .muted{color:var(--muted);font-size:12px}
    #map{position:absolute;inset:52px 0 0 0;touch-action:manipulation}
    .fab{position:fixed;right:16px;bottom:16px;z-index:1100;border:0;border-radius:999px;background:var(--accent);color:#051423;padding:14px 16px;font-weight:800;box-shadow:var(--shadow)} .fab:active{transform:translateY(1px)}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:2000;background:var(--sheet);border-top-left-radius:20px;border-top-right-radius:20px;border:1px solid var(--border);box-shadow:0 -12px 30px rgba(0,0,0,.45);transition:bottom .28s ease;max-height:82vh;display:flex;flex-direction:column}
    .sheet.open{bottom:0} .sheet .drag{width:56px;height:5px;border-radius:999px;background:#24314f;margin:8px auto} .sheet .content{padding:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} .field{display:flex;flex-direction:column;gap:6px} label{font-size:12px;color:var(--muted)}
    input[type="text"],select,input[type="file"]{width:100%;background:#0e1729;color:var(--text);border:1px solid #1f2c49;border-radius:12px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:#183055;color:#e6f0ff;width:100%;font-weight:700} .btn-primary{background:var(--accent);color:#051423} .btn-ok{background:var(--ok);color:#06240e} .btn-ghost{background:#0e1729;border:1px solid #203153;color:#d7e5ff} .btn-danger{background:var(--danger)} .bar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap} .chip{padding:6px 10px;border-radius:999px;background:#0e1729;border:1px solid #22355c;font-size:12px;color:var(--muted)} .color-box{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle}
    .apertura{background:var(--warn)} .limpieza{background:var(--ok)} .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)} .hidden{display:none!important}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px} .grid{display:grid;gap:8px}
    img.preview{width:160px;height:auto;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer}
    .popup-title{font-weight:800;margin-bottom:4px} .popup-meta{font-size:12px;color:#9fb3c7} .popup-img{width:200px;max-width:80vw;border-radius:10px;margin-top:6px;border:1px solid #1f2c49}
    .blocker{position:fixed;inset:0;z-index:3000;display:none;align-items:center;justify-content:center;background:rgba(5,10,20,.55);backdrop-filter:blur(2px)} .blocker .box{background:#0e1729;border:1px solid #203153;color:#eaf2ff;padding:16px 18px;border-radius:14px;min-width:240px;box-shadow:var(--shadow);text-align:center;font-weight:600}
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #29436f;border-top-color:#4cc9f0;animation:sp .9s linear infinite;display:inline-block;margin-right:10px;vertical-align:middle} @keyframes sp{to{transform:rotate(360deg)}}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0e1729;color:#eaf2ff;border:1px solid #203153;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:4000;display:none;font-weight:600;max-width:90vw;text-align:center}
  
/* Layout Step 1: dos columnas responsivas */
.step1-two-col{display:grid;grid-template-columns:1fr;gap:1rem}
@media (min-width:768px){.step1-two-col{grid-template-columns:1fr 1fr}}
.step1-col{display:flex;flex-direction:column;gap:.75rem}


/* RONDA input harmonize */
.step1-col .field input[type="number"]{
  width:100%;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: inherit;
  padding: 8px 12px;
  outline: none;
}
.step1-col .field input[type="number"]::placeholder{ opacity:.6 }


/* === User location marker === */
.leaflet-user-dot{width:18px;height:18px;border-radius:50%;background:#2563eb;border:3px solid #fff;box-shadow:0 0 0 2px rgba(37,99,235,.35)}
.user-pulse{position:absolute;top:50%;left:50%;width:24px;height:24px;margin:-12px 0 0 -12px;border-radius:50%;background:rgba(37,99,235,.22);animation:userPulse 1.8s infinite ease-out}
@keyframes userPulse{0%{transform:scale(.4);opacity:.9}70%{transform:scale(1.6);opacity:.2}100%{transform:scale(2);opacity:0}}

</style>

<style>
/* --- Transici√≥n refinada (deslizamiento + leve escala + sombra) --- */
@keyframes proEnterFromRight{from{opacity:0;transform:translateX(36px) scale(.98)}to{opacity:1;transform:translateX(0) scale(1)}}
@keyframes proExitToLeft{from{opacity:1;transform:translateX(0) scale(1)}to{opacity:0;transform:translateX(-24px) scale(.98)}}
@keyframes proEnterFromLeft{from{opacity:0;transform:translateX(-36px) scale(.98)}to{opacity:1;transform:translateX(0) scale(1)}}
@keyframes proExitToRight{from{opacity:1;transform:translateX(0) scale(1)}to{opacity:0;transform:translateX(24px) scale(.98)}}

.anim-enter-left{animation:proEnterFromRight .42s cubic-bezier(.22,1,.36,1)}
.anim-exit-left{animation:proExitToLeft .32s cubic-bezier(.4,0,.2,1)}
.anim-enter-right{animation:proEnterFromLeft .42s cubic-bezier(.22,1,.36,1)}
.anim-exit-right{animation:proExitToRight .32s cubic-bezier(.4,0,.2,1)}

.step{will-change:transform,opacity}

@media (prefers-reduced-motion: reduce){
  .anim-enter-left,.anim-exit-left,.anim-enter-right,.anim-exit-right{animation:none}
}
/* --- Fin transici√≥n refinada --- */

/* Seguridad visual: spacing consistente en la primera secci√≥n */
.step1-two-col{display:grid;grid-template-columns:1fr;gap:1rem}
@media (min-width:768px){.step1-two-col{grid-template-columns:1fr 1fr}}
.step1-col{display:flex;flex-direction:column;gap:.75rem}
</style>

</head>
<body>
  <header>
    <h1>Captura de Brechas</h1>
    <span class="muted">M√≥vil ‚Ä¢ GPS ‚Ä¢ Fotos (Drive)</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <button id="syncBtn" class="btn btn-ghost" style="padding:8px 10px">üîÑ Actualizar</button>
    </div>
  </header>

  <div id="map"></div>

  <button id="newTramo" class="fab">+ Nuevo tramo</button>
<button id="newRonda" class="fab" style="right:16px; bottom:84px; background:#7c3aed;color:white">+ Ronda</button>

  <section id="sheet" class="sheet" aria-modal="true" role="dialog">
    <div class="drag"></div>
    <div class="content">
      
<div id="step-1" class="grid step active">
  <div class="card">
    <div class="chips" style="margin-bottom:8px">
      <span class="chip"><span class="color-box apertura"></span>Apertura</span>
      <span class="chip"><span class="color-box limpieza"></span>Limpieza</span>
      <span class="chip"><span class="color-box ronda" style="background:#7c3aed"></span>Ronda</span>
    </div>

    <div class="step1-two-col">
      <div class="step1-col">
        <div class="field">
          <label>Sector</label>
          <select id="sector" disabled><option value="">Cargando sectores‚Ä¶</option></select>
        </div>
        <div class="field">
          <label>Subestaci√≥n</label>
          <select id="subestacion" disabled><option value="">Selecciona un sector‚Ä¶</option></select>
        </div>
        <div class="field">
          <label>Circuito</label>
          <select id="circuito" disabled><option value="">Selecciona una subestaci√≥n‚Ä¶</option></select>
        </div>
        <div class="field" id="field-postes-ronda" style="display:none">
          <label>Postes rondados (cantidad)</label>
          <input id="postesCantidad" type="number" min="1" inputmode="numeric" placeholder="0"/>
        </div>
      </div>
      <div class="step1-col">
        <div class="field">
          <label>Tipo de brecha</label>
          <select id="tipo">
            <option value="">Selecciona‚Ä¶</option>
            <option value="Apertura">Apertura de brecha</option>
            <option value="Limpieza">Limpieza de brecha</option>
          </select>
        </div>
        <div class="field">
          <label for="troncalRamal">Troncal/Ramal</label>
          <select id="troncalRamal">
            <option value="">Selecciona‚Ä¶</option>
            <option value="Troncal">Troncal</option>
            <option value="Ramal">Ramal</option>
          </select>
        </div>
        <div class="field">
          <label for="terna">Terna</label>
          <select id="terna">
            <option value="">Selecciona‚Ä¶</option>
            <option value="Sencilla">Sencilla</option>
            <option value="Doble">Doble</option>
            <option value="Triple">Triple</option>
          </select>
        </div>
      </div>
    </div>

    <div class="note">Completa y pulsa <strong>Siguiente</strong>.</div>
    <div class="bar" style="margin-top:10px">
      <button id="s1-cancel" class="btn btn-ghost">Cancelar</button>
      <button id="s1-next" class="btn btn-primary">Siguiente</button>
    </div>
  </div>
</div>
<div id="step-2" class="grid step hidden">
        <div class="card grid">
          <div><strong>Paso 2:</strong> Capturar <u>punto inicial</u> y subir <u>foto opcional</u>.</div>
          <button id="cap-inicio" class="btn btn-primary">Captar punto inicial (GPS)</button>
          <div class="field">
            <label>Foto punto inicial (opcional)</label>
            <input id="fotoInicio" type="file" accept="image/*" capture="environment"/>
          </div>
          <div id="previewInicioWrap" class="hidden">
            <img id="previewInicio" class="preview" alt="Foto inicio"/>
          </div>
          <div class="bar">
            <button id="s2-back" class="btn btn-ghost">Atr√°s</button>
            <button id="s2-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-3" class="grid step hidden">
        <div class="card grid">
          <div><strong>Paso 3:</strong> Capturar <u>punto final</u> y subir <u>foto opcional</u>.</div>
          <button id="cap-fin" class="btn btn-primary">Captar punto final (GPS)</button>
          <div class="field">
            <label>Foto punto final (opcional)</label>
            <input id="fotoFin" type="file" accept="image/*" capture="environment"/>
          </div>
          <div id="previewFinWrap" class="hidden">
            <img id="previewFin" class="preview" alt="Foto final"/>
          </div>
          <div class="bar">
            <button id="s3-back" class="btn btn-ghost">Atr√°s</button>
            <button id="s3-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-4" class="grid step hidden">
        <div class="card grid">
          <div><strong>Resumen</strong> ‚Äî revisa y guarda.</div>
          <div id="resumen" class="grid"></div>
          <div class="bar">
            <button id="s4-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s4-save" class="btn btn-ok">Guardar tramo</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="blocker" class="blocker" aria-hidden="true"><div class="box"><span class="spinner"></span><span id="blockerText">Procesando‚Ä¶</span></div></div>
  <div id="toast" class="toast"></div>

<script>
// -------- Config --------
const APPS_SCRIPT_URL = "/api/sync";  // tu proxy a Apps Script
const IMG_MAX = 1024;
const IMG_QUALITY = 0.72;

// -------- Utilidad UI --------
const $ = (id)=>document.getElementById(id);
function show(id){$(id).classList.remove('hidden')} function hide(id){$(id).classList.add('hidden')}
function toast(msg){const t=$('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2200);}
function showBlocker(t){$('blockerText').textContent=t||'Procesando‚Ä¶';$('blocker').style.display='flex'}
function hideBlocker(){$('blocker').style.display='none'}

// -------- Estado --------
let map, tiles, mapReady=false, pendingRender=false;
const state = { items:[], layers:[], actual:baseActual(), mkInicioTemp:null, mkFinTemp:null};
function baseActual(){return { sector:"", subestacion:"", circuito:"", tipo:"Apertura", inicio:null, fin:null, fotoInicioFile:null, fotoFinFile:null };}
let step=1; const sheet=$('sheet');
function openSheet(){sheet.classList.add('open');}
function closeSheet(){sheet.classList.remove('open'); setStep(1); clearWizard(true); clearTempMarkers();}

function setStep(n){
  if (n===step) return;
  const ids=['step-1','step-2','step-3','step-4'];
  const currentEl = $('step-'+step);
  const nextEl = $('step-'+n);
  if (!nextEl) return;

  // Quita estados previos de animaci√≥n
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.classList.remove('anim-enter-left','anim-exit-left','anim-enter-right','anim-exit-right');
  });

  // Determina direcci√≥n: avanzar -> entra desde derecha (enter-left), salir hacia izquierda (exit-left)
  const forward = n > step;
  const enterClass = forward ? 'anim-enter-left' : 'anim-enter-right';
  const exitClass  = forward ? 'anim-exit-left'  : 'anim-exit-right';

  // Preparar siguiente
  nextEl.classList.remove('hidden');
  // Forzamos reflow para que la animaci√≥n se aplique correctamente
  void nextEl.offsetWidth;
  nextEl.classList.add(enterClass, 'active');

  // Animar salida del actual (si existe)
  if (currentEl) {
    currentEl.classList.add(exitClass);
    currentEl.addEventListener('animationend', function onExit(){
      currentEl.removeEventListener('animationend', onExit);
      currentEl.classList.remove('active', exitClass);
      currentEl.classList.add('hidden');
    }, { once: true });
  }

  // Limpiar clases del entrante al finalizar
  nextEl.addEventListener('animationend', function onEnter(){
    nextEl.removeEventListener('animationend', onEnter);
    nextEl.classList.remove(enterClass);
  }, { once: true });

  step = n;
}


// -------- Imagen: compresi√≥n a JPEG --------
async function readImageBitmap(file){ return await createImageBitmap(file,{imageOrientation:'from-image'}) }
async function imageToBlob(file){
  const bmp = await readImageBitmap(file);
  const ratio = Math.min(1, IMG_MAX/Math.max(bmp.width, bmp.height));
  const w = Math.round(bmp.width * ratio), h = Math.round(bmp.height * ratio);
  let canvas;
  if (typeof OffscreenCanvas !== 'undefined'){
    canvas = new OffscreenCanvas(w, h);
  } else {
    canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.drawImage(bmp, 0, 0, w, h);
  async function toBlob(c, t, q){
    if (c.convertToBlob) return await c.convertToBlob({ type: t, quality: q });
    return await new Promise(r => c.toBlob(r, t, q));
  }
  return await toBlob(canvas, 'image/jpeg', IMG_QUALITY);
}
function blobUrl(b){return URL.createObjectURL(b)}
async function blobToDataURL(b){return await new Promise(r=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b);});}

// -------- GPS --------
function getGPS(){return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej(new Error('Geolocalizaci√≥n no disponible')); navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude,ts:Date.now()}), err=>rej(err), {enableHighAccuracy:true, timeout:10000, maximumAge:0}); });}

// -------- Mapa --------
function whenLeafletReady(cb){
  if (window.L) return cb();
  const iv = setInterval(()=>{ if (window.L){ clearInterval(iv); cb(); } }, 30);
  window.addEventListener('load', ()=>{ if (window.L){ clearInterval(iv); cb(); } });
}
function initMapOnce(){ if(map) return; map=L.map('map',{zoomControl:true});
  // Intento ubicar al usuario y marcar
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      try{ var c = pos.coords; showUserOnMap(c.latitude, c.longitude, c.accuracy); }catch(_e){}
    }, function(_){} , { enableHighAccuracy:true, maximumAge:120000, timeout:5000 });
  }
 tiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}); tiles.addTo(map); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],16),()=>map.setView([14.0723,-87.1921],7),{enableHighAccuracy:true,timeout:6000});}else{map.setView([14.0723,-87.1921],7);} mapReady=true; if(pendingRender){ pendingRender=false; renderAllIncremental(); } }
whenLeafletReady(()=>{ initMapOnce(); });

// -------- Server I/O --------
async function fetchAllFromServer(){
  const url=APPS_SCRIPT_URL+(APPS_SCRIPT_URL.includes('?')?'&':'?')+'mode=all_plus_ronda';
  const r=await fetch(url,{method:'GET'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const data=await r.json();
  const rows=Array.isArray(data.records)?data.records:[];
  return rows.map(r=>{
    const pI=(r.inicio+'').split(',').map(Number), pF=(r.fin+'').split(',').map(Number);
    const ini=(pI.length===2&&!isNaN(pI[0]))?{lat:pI[0],lng:pI[1]}:null;
    const fin=(pF.length===2&&!isNaN(pF[0]))?{lat:pF[0],lng:pF[1]}:null;
    return {
      id:r.id,
      sector:r.sector||'',
      subestacion:r.subestacion||'',
      circuito:r.circuito||'',
      tipo:r.tipo||'',
      troncalRamal:r.troncalRamal||'',
      terna:r.terna||'',
      inicio:ini,
      postesCantidad: (r.postesCantidad!=null ? Number(r.postesCantidad) : (r['POSTES RONDADOS']!=null ? Number(r['POSTES RONDADOS']) : 0)),
      
      fin:fin,
      fotoInicioUrl:r.fotoInicioUrl||'',
      fotoFinUrl:r.fotoFinUrl||'',
      createdAt:r.createdAt||new Date().toISOString()
    };
  });
}

async function syncOneToServer(it){
  const payload = { records: [it] };
  const r = await fetch(APPS_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}


function toProxyImg(u){
  if (!u) return '';
  try {
    const s = String(u).trim();
    // id directo
    if (/^[\w-]{20,}$/.test(s)) return `${APPS_SCRIPT_URL}?mode=img&id=${s}`;
    // /file/d/<ID>/...
    let m = s.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
    if (m && m[1]) return `${APPS_SCRIPT_URL}?mode=img&id=${m[1]}`;
    // ...?id=<ID>
    m = s.match(/[?&]id=([^&]+)/i);
    if (m && m[1]) return `${APPS_SCRIPT_URL}?mode=img&id=${m[1]}`;
    // uc?export=view&id=...
    if (/drive\.google\.com\/uc\?/.test(s)) {
      const mid = s.match(/[?&]id=([^&]+)/i);
      if (mid && mid[1]) return `${APPS_SCRIPT_URL}?mode=img&id=${mid[1]}`;
    }
    // otros or√≠genes
    if (/^https?:\/\//i.test(s)) return s;
    return s;
  } catch { return u; }
}
// -------- Render --------
function clearMapLayers(){ if(!map) return; state.layers.forEach(l=>{try{map.removeLayer(l)}catch(_){}}); state.layers=[] }
function addLayer(l){ state.layers.push(l); if(map) l.addTo(map); }
function tipoColor(t){ if(t==='Ronda') return '#7c3aed'; return t==='Limpieza'?'#22c55e':'#f97316'}


function getPhotoSrcFromUrls(it, which){
  const key = which==='inicio' ? 'fotoInicioUrl' : 'fotoFinUrl';
  const u = it[key];
  if (typeof u === 'string' && u.trim()) return toProxyImg(u.trim());
  return '';
}

function markerPopupHtml(p,t,src,m,id){
  const coords=(p && typeof p.lat==='number' && typeof p.lng==='number')?`Lat: ${p.lat.toFixed(6)} ¬∑ Lng: ${p.lng.toFixed(6)}`:'Coordenadas no v√°lidas';
  const img=src?`<img class="popup-img" src="${src}" alt="foto"/>`:'<div class="popup-meta">Sin foto</div>';
  const actions = id ? `<div style="margin-top:8px"><button class="btn btn-danger" data-act="delete" data-id="${id}" data-lat="${p&&p.lat}" data-lng="${p&&p.lng}">üóëÔ∏è Eliminar</button></div>`:'';
  return `<div style="min-width:220px"><div class="popup-title">${t}</div><div class="popup-meta">${coords}</div><div class="popup-meta">${m}</div>${img}${actions}</div>`;
}

function drawItem(it,fit=false){
  if(!(it && it.inicio && it.fin)) return;
  const col=tipoColor(it.tipo);
  const line=L.polyline([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]],{color:col,weight:5,opacity:.95});
  const mkIni=L.circleMarker([it.inicio.lat,it.inicio.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95});
  const mkFin=L.circleMarker([it.fin.lat,it.fin.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95});
  const fIni = getPhotoSrcFromUrls(it,'inicio'); 
  const fFin = getPhotoSrcFromUrls(it,'fin'); 
  mkIni.bindPopup(()=>markerPopupHtml(it.inicio,`INICIO ‚Äî ${it.circuito}`, fIni, `${it.tipo==='Ronda'?`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ Ronda ‚Ä¢ Postes: ${it.postesCantidad||0}`:`${it.tipo==='Ronda'?`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ Ronda ‚Ä¢ Postes: ${it.postesCantidad||0}`:`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ ${it.tipo} ‚Ä¢ ${it.troncalRamal} ‚Ä¢ ${it.terna}`}`}`, it.id));
  mkFin.bindPopup(()=>markerPopupHtml(it.fin,`FINAL ‚Äî ${it.circuito}`, fFin, `${it.tipo==='Ronda'?`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ Ronda ‚Ä¢ Postes: ${it.postesCantidad||0}`:`${it.tipo==='Ronda'?`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ Ronda ‚Ä¢ Postes: ${it.postesCantidad||0}`:`${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ ${it.tipo} ‚Ä¢ ${it.troncalRamal} ‚Ä¢ ${it.terna}`}`}`, it.id));
  addLayer(line); addLayer(mkIni); addLayer(mkFin);
  if(fit && map){const b=L.latLngBounds([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]]); map.fitBounds(b.pad(0.3));}
}

function renderAllIncremental(){
  if(!map) return;
  clearMapLayers();
  const items=[...state.items];
  let i=0;
  function chunk(){
    const start=performance.now();
    while(i<items.length && (performance.now()-start)<8){
      drawItem(items[i++], false);
    }
    if(i<items.length) requestIdleCallback(chunk,{timeout:60});
  }
  requestIdleCallback(chunk,{timeout:60});
}

// -------- Wizard --------
function clearWizard(resetAll=true){
  if(resetAll){state.actual=baseActual()} else{state.actual.inicio=null;state.actual.fin=null;state.actual.fotoInicioFile=null;state.actual.fotoFinFile=null}
  $('sector').value='';$('subestacion').value='';$('circuito').value='';$('tipo').value='';$('troncalRamal').value='';$('terna').value='';
  $('fotoInicio').value='';$('fotoFin').value='';
  $('previewInicioWrap').classList.add('hidden');$('previewFinWrap').classList.add('hidden');
  $('previewInicio').src='';$('previewFin').src='';
}
function validateStep1(){
  const sector=$('sector').value.trim(), sub=$('subestacion').value.trim(), circ=$('circuito').value.trim();
  const tipo = $('tipo').value.trim();
  const troncalRamal = $('troncalRamal').value.trim();
  const terna = $('terna').value.trim();
  if (window.__modeRonda){
    const pc = parseInt(document.getElementById('postesCantidad').value||'0',10)||0;
    if(!sector||!sub||!circ||pc<=0) return false;
    Object.assign(state.actual,{sector,subestacion:sub,circuito:circ,tipo:'Ronda',troncalRamal:'',terna:'', postesCantidad:pc});
    return true;
  }
  if(!sector||!sub||!circ||!tipo||!troncalRamal||!terna) return false;
  Object.assign(state.actual,{sector,subestacion:sub,circuito:circ,tipo,troncalRamal,terna});
  return true;
}
async function validateStep2(){
  if(!state.actual.inicio){try{await capInicio()}catch(_){}} 
  const f = $('fotoInicio').files && $('fotoInicio').files[0];
  if(!state.actual.inicio) return false; // foto opcional
  if (f){
    state.actual.fotoInicioFile = f;
    const b = await imageToBlob(f);
    $('previewInicio').src = blobUrl(b); $('previewInicioWrap').classList.remove('hidden');
  } else {
    state.actual.fotoInicioFile = null;
    $('previewInicio').src = ''; $('previewInicioWrap').classList.add('hidden');
  }
  return true;
}
async function validateStep3(){
  if(!state.actual.fin){try{await capFin()}catch(_){}} 
  const f = $('fotoFin').files && $('fotoFin').files[0];
  if(!state.actual.fin) return false; // foto opcional
  if (f){
    state.actual.fotoFinFile = f;
    const b = await imageToBlob(f);
    $('previewFin').src = blobUrl(b); $('previewFinWrap').classList.remove('hidden');
  } else {
    state.actual.fotoFinFile = null;
    $('previewFin').src = ''; $('previewFinWrap').classList.add('hidden');
  }
  return true;
}
function fillResumen(){
  const it=state.actual, col=tipoColor(it.tipo);
  const ini=it.inicio?`${it.inicio.lat.toFixed(6)}, ${it.inicio.lng.toFixed(6)}`:'-';
  const fin=it.fin?`${it.fin.lat.toFixed(6)}, ${it.fin.lng.toFixed(6)}`:'-';
  const troncalTerna = (it.tipo==='Ronda')
    ? ''
    : `<div><b>Troncal/Ramal:</b> ${it.troncalRamal}</div><div><b>Terna:</b> ${it.terna}</div>`;
  $('resumen').innerHTML=`<div class="grid">
    <div><b>Sector:</b> ${it.sector}</div>
    <div><b>Subestaci√≥n:</b> ${it.subestacion}</div>
    <div><b>Circuito:</b> ${it.circuito}</div>
    <div><b>Tipo:</b> <span style="color:${col}">${it.tipo}</span></div>
    ${troncalTerna}
    <div><b>Inicio:</b> ${ini}</div>
    <div><b>Final:</b> ${fin}</div>
  </div>`;
}

// === user location helpers ===
let userLayer = null, userMarker = null, userAccuracy = null;
function ensureUserLayer(){
  if (!userLayer){ userLayer = L.layerGroup().addTo(map); }
  return userLayer;
}
function showUserOnMap(lat, lng, accuracy){
  if (!window.L || !window.map) return;
  ensureUserLayer();
  // Clear previous
  if (userLayer){ userLayer.clearLayers(); userMarker = null; userAccuracy = null; }
  // Marker (dot with pulse)
  const icon = L.divIcon({ className:'', html: '<div class="leaflet-user-dot"></div><div class="user-pulse"></div>', iconSize:[24,24], iconAnchor:[12,12] });
  userMarker = L.marker([lat,lng], { icon }).addTo(userLayer).bindPopup('Tu ubicaci√≥n');
  // Accuracy circle (optional)
  if (accuracy && !isNaN(accuracy)){
    userAccuracy = L.circle([lat,lng], { radius: accuracy, weight:1, opacity:.7, fillOpacity:.08 }).addTo(userLayer);
  }
}

// -------- Captura de puntos --------
async function capInicio(){
  const p=await getGPS(); state.actual.inicio = p;
  try{ showUserOnMap(p.lat, p.lng, p.accuracy || 25); }catch(_e){}
  if(state.mkInicioTemp){ try{ map && map.removeLayer(state.mkInicioTemp); }catch(_){ } }
  const mk=L.marker([p.lat,p.lng],{draggable:true,title:'Inicio (ajustable)'}).bindPopup('Arrastra para ajustar inicio');
  mk.on('dragend',e=>{const ll=e.target.getLatLng(); state.actual.inicio={lat:ll.lat,lng:ll.lng,ts:Date.now()}});
  addLayer(mk); state.mkInicioTemp=mk; if(map) mk.openPopup();
}
async function capFin(){
  const p=await getGPS(); state.actual.fin=p;
  if(state.mkFinTemp){ try{ map && map.removeLayer(state.mkFinTemp); }catch(_){ } }
  const mk=L.marker([p.lat,p.lng],{draggable:true,title:'Final (ajustable)'}).bindPopup('Arrastra para ajustar final');
  mk.on('dragend',e=>{const ll=e.target.getLatLng(); state.actual.fin={lat:ll.lat,lng:ll.lng,ts:Date.now()}});
  addLayer(mk); state.mkFinTemp=mk; if(map) mk.openPopup();
}
function clearTempMarkers(){
  try { if(state.mkInicioTemp){ state.mkInicioTemp.remove && state.mkInicioTemp.remove(); state.mkInicioTemp=null; } } catch(_){}
  try { if(state.mkFinTemp){ state.mkFinTemp.remove && state.mkFinTemp.remove(); state.mkFinTemp=null; } } catch(_){}
}


// Wire buttons for GPS capture

// --- Helper: loading spinner en botones ---
function setBtnLoading(btn, loading, label){
  if(!btn) return;
  if(loading){
    btn.dataset._label = btn.dataset._label || btn.textContent;
    btn.innerHTML = '<span class="spinner" aria-hidden="true"></span>' + (label || btn.dataset._label);
    btn.classList.add('loading');
    btn.disabled = true;
  } else {
    const original = btn.dataset._label || btn.textContent;
    btn.textContent = original;
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}



// --- Eliminar por ID (servidor) ---
async function deleteById(id){
  const r = await fetch(APPS_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ op:'delete', id })
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  const data = await r.json();
  if (!data.ok) throw new Error(data.error||'delete failed');
  // quitar del estado y re-render
  state.items = state.items.filter(x=>String(x.id).trim()!==String(id).trim());
  clearMapLayers();
  renderAllIncremental();
  toast('üóëÔ∏è Tramo eliminado');
}

// Delegaci√≥n global: solo Delete
document.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.leaflet-popup [data-act="delete"]');
  if (!btn) return;
  let id  = (btn.getAttribute('data-id') || '').trim();
  const lat = parseFloat(btn.getAttribute('data-lat')||'');
  const lng = parseFloat(btn.getAttribute('data-lng')||'');
  if (id === '' || id === 'undefined' || id === 'null') {
    // Resolver por coordenadas si el id no vino
    const eps = 1e-7;
    const itA = state.items.find(x => x.inicio && Math.abs(x.inicio.lat-lat)<eps && Math.abs(x.inicio.lng-lng)<eps);
    const itB = state.items.find(x => x.fin && Math.abs(x.fin.lat-lat)<eps && Math.abs(x.fin.lng-lng)<eps);
    const it = itA || itB;
    if (it && it.id) id = String(it.id);
  }
  if (!id) { alert('No se pudo determinar el ID a eliminar.'); return; }
  if (!confirm('¬øEliminar este tramo? Esta acci√≥n no se puede deshacer.')) return;
  // feedback visual
  const original = btn.textContent;
  btn.textContent = 'Eliminando‚Ä¶';
  btn.disabled = true;
  try{
    await deleteById(id);
  }catch(e){
    console.warn(e); alert('No se pudo eliminar');
  }finally{
    btn.textContent = original;
    btn.disabled = false;
  }
});

// -------- Guardado --------
document.getElementById('s4-save').onclick = async ()=>{
  if (!(state.actual.inicio && state.actual.fin)){
    toast('Faltan coordenadas v√°lidas de inicio/fin.'); return;
  }
  showBlocker('Guardando‚Ä¶');

  try {
    // Convertimos a dataURL para POST (server guardar√° en Drive y devolver√° URL)
    const fotoInicioB64 = state.actual.fotoInicioFile ? await blobToDataURL(await imageToBlob(state.actual.fotoInicioFile)) : '';
    const fotoFinB64    = state.actual.fotoFinFile   ? await blobToDataURL(await imageToBlob(state.actual.fotoFinFile))   : '';

    const it = {
      id: crypto.randomUUID(),
      sector: state.actual.sector,
      subestacion: state.actual.subestacion,
      circuito: state.actual.circuito,
      tipo: state.actual.tipo,
      troncalRamal: state.actual.troncalRamal,
      terna: state.actual.terna,
      inicio: state.actual.inicio,
      fin: state.actual.fin,
      postesCantidad: (state.actual.tipo==='Ronda') ? (state.actual.postesCantidad||0) : undefined,
      fotoInicio: fotoInicioB64,
      fotoFin: fotoFinB64,
      createdAt: new Date().toISOString()
    };

    const resp = await syncOneToServer(it);
    const okIds = new Set([...(resp.syncedIds||[]), ...(resp.alreadySyncedIds||[])]);
    const urlMap = resp.urlMap || {};

    if (okIds.has(it.id)) {
      // Reemplaza campos de fotos por URLs (Drive)
      it.fotoInicioUrl = (urlMap[it.id]||{}).inicio || '';
      it.fotoFinUrl = (urlMap[it.id]||{}).fin || '';
      // Limpia blobs locales
      delete it.fotoInicio; delete it.fotoFin;
      delete it.fotoInicioFile; delete it.fotoFinFile;

      state.items.push(it);
      drawItem(it, true);
      clearTempMarkers();
      closeSheet();
      toast('‚úÖ Guardado en servidor');
    } else {
      toast('‚ùå No se guard√≥ en servidor');
    }
  } catch (e) {
    console.warn(e);
    toast('‚ùå Error al guardar');
  } finally {
    hideBlocker();
  }
};

// -------- Eventos UI --------
$('newTramo').onclick=()=>{ clearWizard(true); openSheet(); setStep(1) };
$('s1-cancel').onclick=closeSheet;
$('s1-next').onclick=()=>{ if(!validateStep1()){toast('Completa Sector, Subestaci√≥n y Circuito.'); return;} setStep(2); };
$('s2-back').onclick=()=>setStep(1);
$('s2-next').onclick=async ()=>{ const ok=await validateStep2(); if(!ok){toast('Captura el punto inicial. (La foto es opcional)'); return;} setStep(3); };
$('s3-back').onclick=()=>setStep(2);
$('s3-next').onclick=async ()=>{ const ok=await validateStep3(); if(!ok){toast('Captura el punto final. (La foto es opcional)'); return;} fillResumen(); setStep(4); };

$('fotoInicio').addEventListener('change', async e=>{
  if(e.target.files[0]){ const b=await imageToBlob(e.target.files[0]); $('previewInicio').src=blobUrl(b); $('previewInicioWrap').classList.remove('hidden'); }
});
$('fotoFin').addEventListener('change', async e=>{
  if(e.target.files[0]){ const b=await imageToBlob(e.target.files[0]); $('previewFin').src=blobUrl(b); $('previewFinWrap').classList.remove('hidden'); }
});

$('syncBtn').addEventListener('click', async ()=>{
  showBlocker('Actualizando‚Ä¶');
  try {
    state.items = (await fetchAllFromServer());
    if (mapReady) renderAllIncremental();
    toast('‚úÖ Datos actualizados');
  } catch (e) {
    console.warn(e); toast('‚ùå Error al actualizar');
  } finally {
    hideBlocker();
  }
});

// -------- Bootstrap --------
(async function bootstrap(){
  showBlocker('Cargando datos‚Ä¶');
  try {
    state.items = (await fetchAllFromServer());
  } catch (e) {
    console.warn(e);
    state.items = [];
    toast('‚ö†Ô∏è Error al conectar con el servidor');
  } finally {
    hideBlocker();
    if (mapReady) { renderAllIncremental(); } else { pendingRender = true; }
  }
})();
</script>

<!-- === Inyecciones de robustez (polyfills y overrides de imagen) === -->
<script>
// Polyfill requestIdleCallback / cancelIdleCallback
window.requestIdleCallback = window.requestIdleCallback || function (cb, opts) {
  const start = Date.now();
  return setTimeout(function () {
    cb({
      didTimeout: false,
      timeRemaining: function () {
        return Math.max(0, 50 - (Date.now() - start));
      }
    });
  }, (opts && opts.timeout) || 1);
};
window.cancelIdleCallback = window.cancelIdleCallback || function (id) { clearTimeout(id); };

// Fallback para crypto.randomUUID
if (!window.crypto) { window.crypto = {}; }
if (!crypto.randomUUID) {
  crypto.randomUUID = function () {
    const tpl = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
    return tpl.replace(/[xy]/g, function(c){
      let r;
      if (window.crypto && crypto.getRandomValues) {
        r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
      } else {
        r = Math.floor(Math.random() * 16);
      }
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  };
}

// Helper: lee imagen como ImageBitmap si existe, o como Image con dataURL
async function readImageBitmap(file){
  if (window.createImageBitmap) {
    try {
      return await createImageBitmap(file, { imageOrientation: 'from-image' });
    } catch (e) {}
  }
  const dataURL = await new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = dataURL;
  });
  // objeto compatible con drawImage
  return { width: img.width, height: img.height, _img: img };
}

// Override no disruptivo: redefine imageToBlob con fallbacks (la definici√≥n posterior prevalece)
async function imageToBlob(file){
  try {
    // Variables globales esperadas por el proyecto
    const MAX = typeof IMG_MAX !== 'undefined' ? IMG_MAX : 1920;
    const Q = typeof IMG_QUALITY !== 'undefined' ? IMG_QUALITY : 0.85;

    const bmp = await readImageBitmap(file);
    const srcW = bmp.width, srcH = bmp.height;
    const scale = Math.min(1, MAX / Math.max(srcW, srcH));
    const w = Math.round(srcW * scale);
    const h = Math.round(srcH * scale);

    let canvas;
    if (typeof OffscreenCanvas !== 'undefined'){
      canvas = new OffscreenCanvas(w, h);
    } else {
      canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
    }
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.drawImage(bmp._img ? bmp._img : bmp, 0, 0, w, h);

    async function toBlob(c, t, q){
      if (c.convertToBlob) return await c.convertToBlob({ type: t, quality: q });
      return await new Promise(r => c.toBlob(r, t, q));
    }
    return await toBlob(canvas, 'image/jpeg', Q);
  } catch (e) {
    // √öltimo recurso: devolver el archivo original
    return file;
  }
}
</script>

<script>
// Inicializa handlers cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', () => {
  function setBtnLoading(btn, loading, label){
    if(!btn) return;
    if(loading){
      btn.dataset._label = btn.dataset._label || btn.textContent;
      btn.innerHTML = '<span class="spinner" aria-hidden="true"></span>' + (label || btn.dataset._label);
      btn.classList.add('loading');
      btn.disabled = true;
    } else {
      const original = btn.dataset._label || btn.textContent;
      btn.textContent = original;
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  }

  const capIniBtn = document.getElementById('cap-inicio');
  if (capIniBtn) {
    capIniBtn.onclick = async () => {
      setBtnLoading(capIniBtn, true, 'Capturando coordenadas‚Ä¶');
      try {
        await capInicio();
        toast('Punto inicial capturado');
      } catch (e) {
        console.warn(e);
        toast('No se pudo obtener GPS');
      } finally {
        setBtnLoading(capIniBtn, false);
      }
    };
  }

  const capFinBtn = document.getElementById('cap-fin');
  if (capFinBtn) {
    capFinBtn.onclick = async () => {
      setBtnLoading(capFinBtn, true, 'Capturando coordenadas‚Ä¶');
      try {
        await capFin();
        toast('Punto final capturado');
      } catch (e) {
        console.warn(e);
        toast('No se pudo obtener GPS');
      } finally {
        setBtnLoading(capFinBtn, false);
      }
    };
  }
});
</script>
<script>

// ===== Opciones de cat√°logo (Sector / Subestaci√≥n / Circuito) =====
let catalog = { sectors: [], bySector: {}, bySubestacion: {} };

function setSelectOptions(sel, arr, placeholder){
  sel.innerHTML = '';
  if (placeholder) {
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = placeholder;
    sel.appendChild(opt);
  }
  for (const v of arr){
    const o = document.createElement('option');
    o.value = v; o.textContent = v;
    sel.appendChild(o);
  }
}

async function loadCatalog(){
  try{
    const url = APPS_SCRIPT_URL + (APPS_SCRIPT_URL.includes('?') ? '&' : '?') + 'mode=options';
    const r = await fetch(url, { method: 'GET' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (!data || !data.ok) throw new Error('Respuesta inv√°lida');
    catalog.sectors = data.sectors || [];
    catalog.bySector = data.bySector || {};
    catalog.bySubestacion = data.bySubestacion || {};
  }catch(e){
    console.warn('No se pudo cargar cat√°logo', e);
    catalog = { sectors: [], bySector: {}, bySubestacion: {} };
  }
}

function initCascadingSelects(){
  const selSector = document.getElementById('sector');
  const selSub = document.getElementById('subestacion');
  const selCirc = document.getElementById('circuito');

  // Inicial: sectores
  setSelectOptions(selSector, catalog.sectors, 'Selecciona un sector‚Ä¶');
  selSector.disabled = false;

  // Listeners
  selSector.onchange = ()=>{
    const sec = selSector.value;
    const subs = (catalog.bySector[sec] || []);
    setSelectOptions(selSub, subs, subs.length ? 'Selecciona una subestaci√≥n‚Ä¶' : 'Sin subestaciones');
    selSub.disabled = subs.length === 0;
    // Reset circuito
    setSelectOptions(selCirc, [], 'Selecciona una subestaci√≥n‚Ä¶');
    selCirc.disabled = true;
    // Actualiza estado
    state.actual.sector = sec || '';
    state.actual.subestacion = '';
    state.actual.circuito = '';
  };

  selSub.onchange = ()=>{
    const sub = selSub.value;
    const circs = (catalog.bySubestacion[sub] || []);
    setSelectOptions(selCirc, circs, circs.length ? 'Selecciona un circuito‚Ä¶' : 'Sin circuitos');
    selCirc.disabled = circs.length === 0;
    state.actual.subestacion = sub || '';
    state.actual.circuito = '';
  };

  selCirc.onchange = ()=>{
    state.actual.circuito = selCirc.value || '';
  };

  // Preseleccionar si viene de un registro previo
  if (state.actual.sector){
    selSector.value = state.actual.sector;
    selSector.onchange();
    if (state.actual.subestacion){
      selSub.value = state.actual.subestacion;
      selSub.onchange();
      if (state.actual.circuito){
        selCirc.value = state.actual.circuito;
      }
    }
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // Carga cat√°logo y configura selects
  await loadCatalog();
  initCascadingSelects();
});

</script>

<script>
// Elimina nodos de texto "None" hu√©rfanos dentro del Step 1
function stripNoneInStep1(){
  const step = document.getElementById('step-1');
  if(!step) return;
  const walker = document.createTreeWalker(step, NodeFilter.SHOW_TEXT, {
    acceptNode: (n)=> n.nodeValue && n.nodeValue.trim() === 'None' ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT
  });
  const toRemove = [];
  let node; while((node = walker.nextNode())) toRemove.push(node);
  toRemove.forEach(n => n.parentNode && n.parentNode.removeChild(n));
}

// Int√©gralo al flujo existente
document.addEventListener('DOMContentLoaded', stripNoneInStep1);

// Si la app ya define setStep, eng√°nchate sin romper la original
(function(){
  if (typeof setStep !== 'function') return;
  const _setStep = setStep;
  window.setStep = function(n){
    _setStep(n);
    if (n === 1) { try { stripNoneInStep1(); } catch(e){} }
  }
})();
</script>


<script>
// --- Ronda integration (no tocar flujo de TRAMO) ---
window.__modeRonda = false;
function toggleRondaUi(isRonda){
  const showEl = (el, show)=>{ if(!el) return; el.style.display = show?'':'none'; };
  const fieldPostes = document.getElementById('field-postes-ronda');
  const tipoField   = document.getElementById('tipo')?.closest('.field');
  const troncalFld  = document.getElementById('troncalRamal')?.closest('.field');
  const ternaFld    = document.getElementById('terna')?.closest('.field');
  showEl(fieldPostes, !!isRonda);
  showEl(tipoField,   !isRonda);
  showEl(troncalFld,  !isRonda);
  showEl(ternaFld,    !isRonda);
}
document.addEventListener('DOMContentLoaded', ()=>{
  // Asegurar que el click de Tramo mantenga modo normal
  const btnTramo = document.getElementById('newTramo');
  if (btnTramo){
    btnTramo.addEventListener('click', ()=>{ window.__modeRonda=false; toggleRondaUi(false); });
  }
  // Nuevo bot√≥n Ronda: misma secuencia que Tramo
  const btnRonda = document.getElementById('newRonda');
  if (btnRonda){
    btnRonda.addEventListener('click', ()=>{
      window.__modeRonda = true;
      try{ clearWizard(true); }catch(_){}
      try{ openSheet(); }catch(_){}
      try{ setStep(1); }catch(_){}
      toggleRondaUi(true);
    });
  }
});
</script>


<!-- Geo-permission Help Modal -->
<div id="geoHelpModal" class="geohelp-modal hidden" aria-hidden="true">
  <div class="geohelp-panel">
    <h3 style="margin:0 0 8px 0">No se pudo acceder a tu ubicaci√≥n</h3>
    <p style="margin:0 0 8px 0">Para permitir la ubicaci√≥n:</p>
    <ol style="margin:0 0 8px 20px">
      <li>Toca el √≠cono de informaci√≥n del sitio (üîí / ‚ò∞ / ‚ìò) junto a la direcci√≥n URL.</li>
      <li>Busca <b>Ubicaci√≥n</b> y selecciona <b>Permitir</b>.</li>
      <li>Toca <b>üîÑ</b> para recargar esta p√°gina.</li>
    </ol>
    <button id="geoHelpClose" class="geohelp-btn">Entendido</button>
  </div>
</div>
<style>
  .geohelp-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.46);z-index:99999}
  .geohelp-panel{width:min(520px,90vw);background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:14px;padding:16px;box-shadow:0 16px 48px rgba(0,0,0,.35)}
  .geohelp-btn{background:#334155;border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:6px}
  .hidden{display:none !important}
</style>
<script>
function showGeoHelp(err){
  try{
    const m = document.getElementById('geoHelpModal');
    const c = document.getElementById('geoHelpClose');
    if(!m) return;
    m.classList.remove('hidden'); m.setAttribute('aria-hidden','false');
    c && c.addEventListener('click', ()=>{ m.classList.add('hidden'); m.setAttribute('aria-hidden','true'); }, { once:true });
  }catch(_){}
}
</script>


<script>
// Wrapper que detecta errores de permisos en geolocalizaci√≥n
(function(){
  try{
    if (navigator && navigator.geolocation){
      const _orig = navigator.geolocation.getCurrentPosition.bind(navigator.geolocation);
      navigator.geolocation.getCurrentPosition = function(success, error, options){
        const wrapErr = function(e){ try{ showGeoHelp(e); }catch(_){ } if (typeof error==='function') return error(e); };
        return _orig(success, wrapErr, options);
      };
    }
  }catch(_){}
})();
</script>

</body>
</html>
