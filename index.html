<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="icon" href="data:,"/>
  <title>Captura de Brechas — Móvil Optimizado</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
try{$('s1-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s2-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s3-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s4-cancel').onclick=()=>{ closeSheet(); };}catch(_){}

</script>

  <style>
    :root{--bg:#0b1220;--card:#0f182a;--muted:#8aa0b6;--text:#ecf3ff;--accent:#4cc9f0;--ok:#22c55e;--warn:#f97316;--danger:#ef4444;--border:#1d2a45;--sheet:#0b1220;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text);overflow:hidden;-webkit-tap-highlight-color:transparent}
    header{position:fixed;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:10px;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:12px 14px}
    header h1{margin:0;font-size:16px} header .muted{color:var(--muted);font-size:12px}
    #map{position:absolute;inset:52px 0 0 0;touch-action:manipulation}
    .fab{position:fixed;right:16px;bottom:16px;z-index:1100;border:0;border-radius:999px;background:var(--accent);color:#051423;padding:14px 16px;font-weight:800;box-shadow:var(--shadow)} .fab:active{transform:translateY(1px)}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:2000;background:var(--sheet);border-top-left-radius:20px;border-top-right-radius:20px;border:1px solid var(--border);box-shadow:0 -12px 30px rgba(0,0,0,.45);transition:bottom .28s ease;max-height:82vh;display:flex;flex-direction:column}
    .sheet.open{bottom:0} .sheet .drag{width:56px;height:5px;border-radius:999px;background:#24314f;margin:8px auto} .sheet .content{padding:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} .field{display:flex;flex-direction:column;gap:6px} label{font-size:12px;color:var(--muted)}
    input[type="text"],select,input[type="file"]{width:100%;background:#0e1729;color:var(--text);border:1px solid #1f2c49;border-radius:12px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:#183055;color:#e6f0ff;width:100%;font-weight:700} .btn-primary{background:var(--accent);color:#051423} .btn-ok{background:var(--ok);color:#06240e} .btn-ghost{background:#0e1729;border:1px solid #203153;color:#d7e5ff} .btn-danger{background:var(--danger)} .bar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap} .chip{padding:6px 10px;border-radius:999px;background:#0e1729;border:1px solid #22355c;font-size:12px;color:var(--muted)} .color-box{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle}
    .apertura{background:var(--warn)} .limpieza{background:var(--ok)} .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)} .hidden{display:none!important}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px} .grid{display:grid;gap:8px}
    img.preview{width:160px;height:auto;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:transform .2s ease} img.preview:hover{transform:scale(1.05)}
    .popup-title{font-weight:800;margin-bottom:4px} .popup-meta{font-size:12px;color:#9fb3c7} .popup-img{width:200px;max-width:80vw;border-radius:10px;margin-top:6px;border:1px solid #1f2c49}
    .pending-banner{position:fixed;left:0;right:0;bottom:0;z-index:1500;background:#2a1d0b;color:#ffe7c2;border-top:1px solid #4b2e0f;padding:8px 12px;font-size:13px;display:none} .pending-banner strong{color:#ffd39a}
    .blocker{position:fixed;inset:0;z-index:3000;display:none;align-items:center;justify-content:center;background:rgba(5,10,20,.55);backdrop-filter:blur(2px)} .blocker .box{background:#0e1729;border:1px solid #203153;color:#eaf2ff;padding:16px 18px;border-radius:14px;min-width:240px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center;font-weight:600}
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #29436f;border-top-color:#4cc9f0;animation:sp .9s linear infinite;display:inline-block;margin-right:10px;vertical-align:middle} @keyframes sp{to{transform:rotate(360deg)}}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0e1729;color:#eaf2ff;border:1px solid #203153;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:4000;display:none;font-weight:600;max-width:90vw;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>Captura de Brechas</h1>
    <span class="muted">Móvil • GPS • Fotos</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <button id="syncBtn" class="btn btn-ghost" style="padding:8px 10px">🔄 Sincronizar</button>
    </div>
  </header>

  <div id="map"></div>

  <button id="newTramo" class="fab">+ Nuevo tramo</button>

  <section id="sheet" class="sheet" aria-modal="true" role="dialog">
    <div class="drag"></div>
    <div class="content">
      <div id="step-1" class="grid">
        <div class="card">
          <div class="chips" style="margin-bottom:8px">
            <span class="chip"><span class="color-box apertura"></span>Apertura</span>
            <span class="chip"><span class="color-box limpieza"></span>Limpieza</span>
          </div>
          <div class="row">
            <div class="field">
              <label>Sector</label>
              <input id="sector" type="text" placeholder="Ej: Norte" autocomplete="one-time-code"/>
            </div>
            <div class="field">
              <label>Subestación</label>
              <input id="subestacion" type="text" placeholder="Ej: S/E Progreso"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Circuito</label>
              <input id="circuito" type="text" placeholder="Ej: CIR-123"/>
            </div>
            <div class="field">
              <label>Tipo de brecha</label>
              <select id="tipo">
                <option value="Apertura">Apertura de brecha</option>
                <option value="Limpieza">Limpieza de brecha</option>
              </select>
            </div>
          </div>
          <div class="note">Completa y pulsa <strong>Siguiente</strong>.</div>
          <div class="bar" style="margin-top:10px">
            <button id="s1-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s1-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-2" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 2:</strong> Capturar <u>punto inicial</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-inicio" class="btn btn-primary">Captar punto inicial (GPS)</button>
          <div class="field">
            <label>Foto punto inicial (requerida)</label>
            <input id="fotoInicio" type="file" accept="image/*" capture="environment"/>
          </div>
          <div id="previewInicioWrap" class="hidden">
            <img id="previewInicio" class="preview" alt="Foto inicio"/>
          </div>
          <div class="bar">
            <button id="s2-back" class="btn btn-ghost">Atrás</button>
            <button id="s2-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-3" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 3:</strong> Capturar <u>punto final</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-fin" class="btn btn-primary">Captar punto final (GPS)</button>
          <div class="field">
            <label>Foto punto final (requerida)</label>
            <input id="fotoFin" type="file" accept="image/*" capture="environment"/>
          </div>
          <div id="previewFinWrap" class="hidden">
            <img id="previewFin" class="preview" alt="Foto final"/>
          </div>
          <div class="bar">
            <button id="s3-back" class="btn btn-ghost">Atrás</button>
            <button id="s3-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-4" class="grid hidden">
        <div class="card grid">
          <div><strong>Resumen</strong> — revisa y guarda.</div>
          <div id="resumen" class="grid"></div>
          <div class="bar">
            <button id="s4-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s4-save" class="btn btn-ok">Guardar tramo</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="blocker" class="blocker" aria-hidden="true"><div class="box"><span class="spinner"></span><span id="blockerText">Procesando…</span></div></div>
  <div id="toast" class="toast"></div>

<script>
// Polyfills
window.requestIdleCallback = window.requestIdleCallback || function(cb){ return setTimeout(()=>cb({ timeRemaining:()=>0, didTimeout:true }), 1); };
window.cancelIdleCallback = window.cancelIdleCallback || function(id){ clearTimeout(id); };

function whenLeafletReady(cb){
  if (window.L) return cb();
  const iv = setInterval(()=>{ if (window.L){ clearInterval(iv); cb(); } }, 30);
  window.addEventListener('load', ()=>{ if (window.L){ clearInterval(iv); cb(); } });
}

const APPS_SCRIPT_URL = "/api/sync";
const IMG_MAX = 1280;
const IMG_QUALITY = 0.82;
let map, tiles, mapReady=false, pendingRender=false;

// [offline storage removed for online-first testing]
const $ = id=>document.getElementById(id);
const state = { items:[], layers:[], actual:baseActual(), mkInicioTemp:null, mkFinTemp:null, _objUrls:new Map() };
function baseActual(){return { sector:"", subestacion:"", circuito:"", tipo:"Apertura", inicio:null, fin:null, fotoInicio:null, fotoFin:null};}
let step=1; const sheet=$('sheet');
function openSheet(){sheet.classList.add('open');}
function closeSheet(){sheet.classList.remove('open'); setStep(1); clearWizard(false); clearTempMarkers();}
function show(id){$(id).classList.remove('hidden')} function hide(id){$(id).classList.add('hidden')}
function setStep(n){step=n;['step-1','step-2','step-3','step-4'].forEach(hide); show('step-'+n);}
function toast(msg){const t=$('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2200);}
function showBlocker(t){$('blockerText').textContent=t||'Procesando…';$('blocker').style.display='flex'}
function hideBlocker(){$('blocker').style.display='none'}
function tipoColor(t){return t==='Limpieza'?'#22c55e':'#f97316'}


function clearTempMarkers(){
  try {
    if (state.mkInicioTemp){
      try { removeLayer(state.mkInicioTemp); } catch(_) { try{ state.mkInicioTemp.remove && state.mkInicioTemp.remove(); }catch(_){ } }
      state.mkInicioTemp = null;
    }
    if (state.mkFinTemp){
      try { removeLayer(state.mkFinTemp); } catch(_) { try{ state.mkFinTemp.remove && state.mkFinTemp.remove(); }catch(_){ } }
      state.mkFinTemp = null;
    }
  } catch (e) {
    console.warn('No se pudo limpiar marcadores temporales', e);
  }
}
function updatePendingUI(){
  const b = document.getElementById('pendingBadge');
  const ban = document.getElementById('pendingBanner');
  if (b) b.style.display='none';
  if (ban) ban.style.display='none';
}


async function readImageBitmap(file){ return await createImageBitmap(file,{imageOrientation:'from-image'}) }
async function imageToBlob(file){
  const bmp = await readImageBitmap(file);
  const ratio = Math.min(1, IMG_MAX/Math.max(bmp.width, bmp.height));
  const w = Math.round(bmp.width * ratio), h = Math.round(bmp.height * ratio);
  let canvas;
  if (typeof OffscreenCanvas !== 'undefined'){
    canvas = new OffscreenCanvas(w, h);
  } else {
    canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.drawImage(bmp, 0, 0, w, h);
  async function toBlob(c, t, q){
    if (c.convertToBlob) return await c.convertToBlob({ type: t, quality: q });
    return await new Promise(r => c.toBlob(r, t, q));
  }
  // Always JPEG for server compatibility
  return await toBlob(canvas, 'image/jpeg', IMG_QUALITY);
}
function blobUrl(b){return URL.createObjectURL(b)}
async function blobToDataURL(b){return await new Promise(r=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b);});}

function getGPS(){return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej(new Error('Geolocalización no disponible')); navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude,ts:Date.now()}), err=>rej(err), {enableHighAccuracy:true, timeout:10000, maximumAge:0}); });}

function initMapOnce(){ if(map) return; map=L.map('map',{zoomControl:true}); tiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}); tiles.addTo(map); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],16),()=>map.setView([14.0723,-87.1921],7),{enableHighAccuracy:true,timeout:6000});}else{map.setView([14.0723,-87.1921],7);} mapReady=true; if(pendingRender){ pendingRender=false; renderAllIncremental(); } }
whenLeafletReady(()=>{ initMapOnce(); });

async function fetchAllFromServer(){ if(!APPS_SCRIPT_URL) return []; const url=APPS_SCRIPT_URL+(APPS_SCRIPT_URL.includes('?')?'&':'?')+'mode=all'; const r=await fetch(url,{method:'GET'}); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json(); const rows=Array.isArray(data.records)?data.records:[]; return rows.map(r=>{const pI=(r.inicio+'').split(',').map(Number), pF=(r.fin+'').split(',').map(Number); const ini=(pI.length===2&&!isNaN(pI[0]))?{lat:pI[0],lng:pI[1]}:null; const fin=(pF.length===2&&!isNaN(pF[0]))?{lat:pF[0],lng:pF[1]}:null; return {id:r.id,sector:r.sector||'',subestacion:r.subestacion||'',circuito:r.circuito||'',tipo:r.tipo||'Apertura',inicio:ini,fin:fin,fotoInicioUrl:r.fotoInicioUrl||'',fotoFinUrl:r.fotoFinUrl||'',synced:true,createdAt:r.createdAt||new Date().toISOString()};});}
function normalizePoint(p){ if(!p) return null; if(typeof p==='string'){ const a=p.split(',').map(Number); if(a.length===2 && !isNaN(a[0]) && !isNaN(a[1])) return {lat:a[0],lng:a[1]}; return null;} if(typeof p.lat==='number' && typeof p.lng==='number') return p; return null; }
function normalizeItem(it){ return { ...it, inicio: normalizePoint(it.inicio), fin: normalizePoint(it.fin) }; }

async function bootstrap(){
  showBlocker('Cargando datos…');
  try {
    const server = await fetchAllFromServer();
    state.items = (server || []).map(normalizeItem);
  } catch (e) {
    state.items = [];
    toast('⚠️ Error al conectar con el servidor.');
    console.warn(e);
  } finally {
    hideBlocker();
    if (mapReady) { renderAllIncremental(); } else { pendingRender = true; }
  }
}
bootstrap();


function clearMapLayers(){ if(!map) return; state.layers.forEach(l=>{try{map.removeLayer(l)}catch(_){}}); state.layers=[] }
function addLayer(l){ state.layers.push(l); if(map) l.addTo(map); }

function removeLayer(l){
  try{
    if (!l) return;
    if (l.remove) { l.remove(); return; }              // Leaflet layers have .remove()
    if (typeof map !== 'undefined' && map && map.removeLayer) { map.removeLayer(l); }
  }catch(e){ console.warn('removeLayer fallo', e); }
  // además, quita de state.layers si está
  try{
    if (state && Array.isArray(state.layers)){
      const i = state.layers.indexOf(l);
      if (i >= 0) state.layers.splice(i,1);
    }
  }catch(_){}
}
function hasValidPoint(p){return !!(p && typeof p.lat==='number' && !isNaN(p.lat) && typeof p.lng==='number' && !isNaN(p.lng));}

function getPhotoSrc(it, which){
  const urlKey = which==='inicio' ? 'fotoInicioUrl' : 'fotoFinUrl';
  const blobKey = which==='inicio' ? 'fotoInicio' : 'fotoFin';

  // Helper: normalize a potential string into a usable image src
  const normalize = (s)=>{
    if (!s) return '';
    const str = String(s).trim();
    // Already a data URL
    if (str.startsWith('data:image')) return str;
    // Looks like http(s) or protocol-relative
    if (/^https?:\/\//i.test(str) || /^\/\//.test(str) || str.startsWith('/')) return str;
    // Looks like raw base64 (no header). Heuristic: long, base64 charset
    if (/^[A-Za-z0-9+/=\s]+$/.test(str) && str.replace(/\s+/g,'').length > 100) {
      return 'data:image/jpeg;base64,' + str.replace(/\s+/g,'');
    }
    return '';
  };

  // 1) If we have a remote URL (or dataURL-like string), use it
  const u = it[urlKey];
  const uNorm = normalize(u);
  if (uNorm) return uNorm;

  // 2) If we have a Blob, create/reuse object URL
  const b = it[blobKey];
  if (b instanceof Blob) {
    try {
      const key = it.id + ':' + blobKey;
      state._objUrls = state._objUrls || new Map();
      if (!state._objUrls.has(key)) state._objUrls.set(key, URL.createObjectURL(b));
      return state._objUrls.get(key);
    } catch (e) { console.warn('No se pudo crear ObjectURL', e); }
  }

  // 3) If we have a string value that might be base64, normalize
  if (typeof b === 'string') {
    const bNorm = normalize(b);
    if (bNorm) return bNorm;
  }

  return '';
}
function markerPopupHtml(p,t,f,m){ const coords=(p && typeof p.lat==='number' && typeof p.lng==='number')?`Lat: ${p.lat.toFixed(6)} · Lng: ${p.lng.toFixed(6)}`:'Coordenadas no válidas'; const img=f?`<img class="popup-img" loading="lazy" src="${f}" alt="foto"/>`:'<div class="popup-meta">Sin foto</div>'; return `<div style="min-width:220px"><div class="popup-title">${t}</div><div class="popup-meta">${coords}</div><div class="popup-meta">${m}</div>${img}</div>`; }
function drawItem(it,fit=false){ if(!hasValidPoint(it.inicio) || !hasValidPoint(it.fin)) return; const col=tipoColor(it.tipo); const line=L.polyline([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]],{color:col,weight:5,opacity:.95}); const mkIni=L.circleMarker([it.inicio.lat,it.inicio.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); const mkFin=L.circleMarker([it.fin.lat,it.fin.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); const fIni = getPhotoSrc(it,'inicio') || (typeof it.fotoInicio==='string' ? it.fotoInicio : '') || (typeof it.fotoInicioUrl==='string' ? it.fotoInicioUrl : '');
const fFin = getPhotoSrc(it,'fin') || (typeof it.fotoFin==='string' ? it.fotoFin : '') || (typeof it.fotoFinUrl==='string' ? it.fotoFinUrl : ''); mkIni.bindPopup(()=>markerPopupHtml(it.inicio,`INICIO — ${it.circuito}`, fIni, `${it.sector} • ${it.subestacion} • ${it.tipo}`)); mkFin.bindPopup(()=>markerPopupHtml(it.fin,`FINAL — ${it.circuito}`, fFin, `${it.sector} • ${it.subestacion} • ${it.tipo}`)); addLayer(line); addLayer(mkIni); addLayer(mkFin); if(fit && map){const b=L.latLngBounds([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]]); map.fitBounds(b.pad(0.3));} }
function renderAllIncremental(){ if(!map) return; clearMapLayers(); const items=[...state.items]; let i=0; function chunk(){ const start=performance.now(); while(i<items.length && (performance.now()-start)<8){ drawItem(items[i++], false);} if(i<items.length) requestIdleCallback(chunk,{timeout:60}); } requestIdleCallback(chunk,{timeout:60}); }

function clearWizard(resetAll=true){ if(resetAll){state.actual=baseActual()} else{state.actual.inicio=null;state.actual.fin=null;state.actual.fotoInicio=null;state.actual.fotoFin=null} $('sector').value='';$('subestacion').value='';$('circuito').value='';$('tipo').value='Apertura'; $('fotoInicio').value='';$('fotoFin').value='';$('previewInicioWrap').classList.add('hidden');$('previewFinWrap').classList.add('hidden');$('previewInicio').src='';$('previewFin').src='';}
function validateStep1(){ const sector=$('sector').value.trim(), sub=$('subestacion').value.trim(), circ=$('circuito').value.trim(); if(!sector||!sub||!circ) return false; Object.assign(state.actual,{sector,subestacion:sub,circuito:circ,tipo:$('tipo').value}); return true; }
async function validateStep2(){ if(!state.actual.inicio){try{await capInicio()}catch(_){}} const f=$('fotoInicio').files[0]; if(!state.actual.inicio||!f) return false; const b=await imageToBlob(f); state.actual.fotoInicio=b; $('previewInicio').src=blobUrl(b); $('previewInicioWrap').classList.remove('hidden'); return true; }
async function validateStep3(){ if(!state.actual.fin){try{await capFin()}catch(_){}} const f=$('fotoFin').files[0]; if(!state.actual.fin||!f) return false; const b=await imageToBlob(f); state.actual.fotoFin=b; $('previewFin').src=blobUrl(b); $('previewFinWrap').classList.remove('hidden'); return true; }
function fillResumen(){ const it=state.actual, col=tipoColor(it.tipo); const ini=hasValidPoint(it.inicio)?`${it.inicio.lat.toFixed(6)}, ${it.inicio.lng.toFixed(6)}`:'-'; const fin=hasValidPoint(it.fin)?`${it.fin.lat.toFixed(6)}, ${it.fin.lng.toFixed(6)}`:'-'; $('resumen').innerHTML=`<div class="grid"><div><b>Sector:</b> ${it.sector}</div><div><b>Subestación:</b> ${it.subestacion}</div><div><b>Circuito:</b> ${it.circuito}</div><div><b>Tipo:</b> <span style="color:${col}">${it.tipo}</span></div><div><b>Inicio:</b> ${ini}</div><div><b>Final:</b> ${fin}</div></div>`; }

async function capInicio(){
 if (state.mkInicioTemp){ try{ removeLayer(state.mkInicioTemp); }catch(_){} state.mkInicioTemp=null; }
 const p=await getGPS(); state.actual.inicio=p; if(state.mkInicioTemp){try{map && map.removeLayer(state.mkInicioTemp)}catch(_){}} const mk=L.marker([p.lat,p.lng],{draggable:true,title:'Inicio (ajustable)'}).bindPopup('Arrastra para ajustar inicio'); mk.on('dragend',e=>{const ll=e.target.getLatLng(); state.actual.inicio={lat:ll.lat,lng:ll.lng,ts:Date.now()}}); addLayer(mk); state.mkInicioTemp=mk; if(map) mk.openPopup(); }
async function capFin(){
 if (state.mkFinTemp){ try{ removeLayer(state.mkFinTemp); }catch(_){} state.mkFinTemp=null; }
 const p=await getGPS(); state.actual.fin=p; if(state.mkFinTemp){try{map && map.removeLayer(state.mkFinTemp)}catch(_){}} const mk=L.marker([p.lat,p.lng],{draggable:true,title:'Final (ajustable)'}).bindPopup('Arrastra para ajustar final'); mk.on('dragend',e=>{const ll=e.target.getLatLng(); state.actual.fin={lat:ll.lat,lng:ll.lng,ts:Date.now()}}); addLayer(mk); state.mkFinTemp=mk; if(map) mk.openPopup(); }

async function syncToServer(pendientes){ if(!APPS_SCRIPT_URL) return {ok:false,error:'Sin URL'}; const payloadRecords=[]; const skipped=[]; for(const it of pendientes){ if(!hasValidPoint(it.inicio)||!hasValidPoint(it.fin)){ skipped.push(it.id); continue; } const rec={...it}; if(it.fotoInicio && it.fotoInicio instanceof Blob){ rec.fotoInicio = await blobToDataURL(it.fotoInicio); } if(it.fotoFin && it.fotoFin instanceof Blob){ rec.fotoFin = await blobToDataURL(it.fotoFin); } rec.inicio = { lat: it.inicio.lat, lng: it.inicio.lng }; rec.fin = { lat: it.fin.lat, lng: it.fin.lng }; payloadRecords.push(rec);} const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),45000); const r=await fetch(APPS_SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({records:payloadRecords}),signal:controller.signal}); clearTimeout(t); if(!r.ok) throw new Error('HTTP '+r.status); const resp=await r.json(); resp.skippedIds=skipped; return resp; }
async function syncPending(){
  showBlocker('Sincronizando…');
  try {
    const data = await fetchAllFromServer();
    state.items = (data || []).map(normalizeItem);
    if (mapReady) { renderAllIncremental(); }
    toast('✅ Datos actualizados');
  } catch (e) {
    console.warn(e);
    toast('❌ Error al sincronizar');
  } finally {
    hideBlocker();
  }
}

$('newTramo').onclick=()=>{openSheet(); setStep(1)}; $('s1-cancel').onclick=closeSheet; $('s1-next').onclick=()=>{ if(!validateStep1()){toast('Completa Sector, Subestación y Circuito.'); return;} setStep(2); }; $('s2-back').onclick=()=>setStep(1); $('s2-next').onclick=async ()=>{ const ok=await validateStep2(); if(!ok){toast('Captura el punto inicial y selecciona una foto.'); return;} setStep(3); }; $('s3-back').onclick=()=>setStep(2); $('s3-next').onclick=async ()=>{ const ok=await validateStep3(); if(!ok){toast('Captura el punto final y selecciona una foto.'); return;} fillResumen(); setStep(4); };
document.getElementById('s4-save').onclick = async ()=>{
  // normaliza fotos a dataURL (como la versión anterior)
  if (state.actual.fotoInicio instanceof Blob) { try { state.actual.fotoInicio = await blobToDataURL(state.actual.fotoInicio); } catch(_){} }
  if (state.actual.fotoFin instanceof Blob) { try { state.actual.fotoFin = await blobToDataURL(state.actual.fotoFin); } catch(_){} }

  if (!hasValidPoint(state.actual.inicio) || !hasValidPoint(state.actual.fin)){
    toast('Faltan coordenadas válidas de inicio/fin.');
    return;
  }
  showBlocker('Guardando…');
  const it = {
    id: crypto.randomUUID(),
    sector: state.actual.sector,
    subestacion: state.actual.subestacion,
    circuito: state.actual.circuito,
    tipo: state.actual.tipo,
    inicio: state.actual.inicio,
    fin: state.actual.fin,
    fotoInicio: state.actual.fotoInicio,
    fotoFin: state.actual.fotoFin,
    createdAt: new Date().toISOString(),
    synced: true
  };
  try {
    const resp = await syncToServer([it]);
    const okIds = new Set([...(resp.syncedIds||[]), ...(resp.alreadySyncedIds||[])]);
    const urlMap = resp.urlMap || {};
    if (okIds.has(it.id)) {
      it.fotoInicioUrl = (urlMap[it.id]||{}).inicio || '';
      it.fotoFinUrl = (urlMap[it.id]||{}).fin || '';
      state.items.push(it);
      if (mapReady){ drawItem(it,true); }
          clearTempMarkers();
      closeSheet();
      toast('✅ Guardado en servidor');
    } else {
      toast('❌ No se guardó en servidor');
    }
  } catch (e) {
    console.warn(e);
    toast('❌ Error al guardar en servidor');
  } finally {
    hideBlocker();
  }
};

$('cap-inicio').onclick=async ()=>{try{await capInicio(); toast('Punto inicial capturado');}catch(_){toast('No se pudo obtener ubicación')}};
$('cap-fin').onclick=async ()=>{try{await capFin(); toast('Punto final capturado');}catch(_){toast('No se pudo obtener ubicación')}};
$('fotoInicio').addEventListener('change', async e=>{ if(e.target.files[0]){ const b=await imageToBlob(e.target.files[0]); $('previewInicio').src=blobUrl(b); $('previewInicioWrap').classList.remove('hidden'); state.actual.fotoInicio=b; }});
$('fotoFin').addEventListener('change', async e=>{ if(e.target.files[0]){ const b=await imageToBlob(e.target.files[0]); $('previewFin').src=blobUrl(b); $('previewFinWrap').classList.remove('hidden'); state.actual.fotoFin=b; }});
$('syncBtn').addEventListener('click', syncPending);

document.addEventListener('click', e=>{const el=e.target; if(el && el.classList && el.classList.contains('preview')){ try{ window.open(el.src,'_blank'); }catch(_){}}});
window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && map){ setTimeout(()=>map.invalidateSize(),150); } }, {passive:true});

try{$('s1-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s2-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s3-cancel').onclick=()=>{ closeSheet(); };}catch(_){}
try{$('s4-cancel').onclick=()=>{ closeSheet(); };}catch(_){}

</script>
</body>
</html>
