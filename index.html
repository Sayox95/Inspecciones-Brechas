<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<link rel="icon" href="data:,"/>
<title>Captura de Brechas ‚Äî M√≥vil Optimizado v5</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{--bg:#0b1220;--card:#0f182a;--muted:#8aa0b6;--text:#ecf3ff;--accent:#4cc9f0;--ok:#22c55e;--warn:#f97316;--border:#1d2a45}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text);overflow:hidden}
header{position:fixed;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:8px;background:#0b1220e6;border-bottom:1px solid var(--border);padding:10px 12px}
#map{position:absolute;inset:48px 0 0 0;touch-action:manipulation}
.card{background:#0f182a;border:1px solid var(--border);border-radius:12px;padding:10px}
.hidden{display:none!important} .grid{display:grid;gap:8px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,select{width:100%;background:#0e1729;color:#ecf3ff;border:1px solid #1f2c49;border-radius:10px;padding:10px 12px}
.btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;background:#183055;color:#e6f0ff;font-weight:700}
.btn-primary{background:var(--accent);color:#051423} .btn-ok{background:var(--ok);color:#06240e} .btn-ghost{background:#0e1729;border:1px solid #203153}
.fab{position:fixed;right:12px;bottom:12px;z-index:1100;border:0;border-radius:999px;background:var(--accent);color:#051423;padding:12px 14px;font-weight:800}
.sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:2000;background:#0b1220;border-top:1px solid var(--border);border-top-left-radius:16px;border-top-right-radius:16px;transition:bottom .25s;max-height:82vh;display:flex;flex-direction:column}
.sheet.open{bottom:0} .content{padding:12px;overflow:auto}
img.preview{width:160px;border-radius:10px;border:1px solid #1f2c49}
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0e1729;color:#eaf2ff;border:1px solid #203153;padding:8px 12px;border-radius:10px;display:none}
.popup-img{width:200px;max-width:80vw;border-radius:10px;border:1px solid #1f2c49;margin-top:6px}
.badge{border:1px solid #203153;padding:4px 8px;border-radius:999px;color:#8aa0b6}
</style>
</head>
<body>
<header>
  <strong>Captura de Brechas</strong>
  <span id="pendingBadge" class="badge" style="margin-left:auto;display:none"></span>
  <button id="syncBtn" class="btn btn-ghost">üîÑ Sincronizar</button>
</header>
<div id="map"></div>
<button id="newTramo" class="fab">+ Tramo</button>

<section id="sheet" class="sheet" role="dialog" aria-modal="true">
  <div class="content">
    <div id="step-1" class="grid">
      <div class="card">
        <div class="row">
          <div><label>Sector</label><input id="sector" placeholder="Ej: Norte"></div>
          <div><label>Subestaci√≥n</label><input id="subestacion" placeholder="Ej: S/E Progreso"></div>
        </div>
        <div class="row">
          <div><label>Circuito</label><input id="circuito" placeholder="Ej: CIR-123"></div>
          <div><label>Tipo</label><select id="tipo"><option>Apertura</option><option>Limpieza</option></select></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="s1-cancel" class="btn btn-ghost">Cancelar</button>
          <button id="s1-next" class="btn btn-primary">Siguiente</button>
        </div>
      </div>
    </div>

    <div id="step-2" class="grid hidden">
      <div class="card grid">
        <div><b>Paso 2:</b> Captura <u>punto inicial</u> + foto.</div>
        <div class="row">
          <button id="cap-inicio" class="btn btn-primary">üìç GPS inicio</button>
          <button id="cap-inicio-tap" class="btn btn-ghost">üëÜ Tocar mapa</button>
        </div>
        <div><label>Foto inicio</label><input id="fotoInicio" type="file" accept="image/*" capture="environment"></div>
        <div id="previewInicioWrap" class="hidden"><img id="previewInicio" class="preview" alt="Foto inicio"/></div>
        <div class="row">
          <button id="s2-back" class="btn btn-ghost">Atr√°s</button>
          <button id="s2-next" class="btn btn-primary">Siguiente</button>
        </div>
      </div>
    </div>

    <div id="step-3" class="grid hidden">
      <div class="card grid">
        <div><b>Paso 3:</b> Captura <u>punto final</u> + foto.</div>
        <div class="row">
          <button id="cap-fin" class="btn btn-primary">üìç GPS final</button>
          <button id="cap-fin-tap" class="btn btn-ghost">üëÜ Tocar mapa</button>
        </div>
        <div><label>Foto final</label><input id="fotoFin" type="file" accept="image/*" capture="environment"></div>
        <div id="previewFinWrap" class="hidden"><img id="previewFin" class="preview" alt="Foto final"/></div>
        <div class="row">
          <button id="s3-back" class="btn btn-ghost">Atr√°s</button>
          <button id="s3-next" class="btn btn-primary">Siguiente</button>
        </div>
      </div>
    </div>

    <div id="step-4" class="grid hidden">
      <div class="card grid">
        <div><b>Resumen</b></div>
        <div id="resumen"></div>
        <div class="row">
          <button id="s4-cancel" class="btn btn-ghost">Cancelar</button>
          <button id="s4-save" class="btn btn-ok">Guardar tramo</button>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast"></div>

<script>
// ==== Utilidades & Estado ====
const $ = id=>document.getElementById(id);
function toast(m){const t=$('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2200);}
const state = { items:[], layers:[], actual:baseActual(), mkI:null, mkF:null, _objUrls:new Map(), _tapMode:null };
function baseActual(){return { sector:'', subestacion:'', circuito:'', tipo:'Apertura', inicio:null, inicioStr:'', fin:null, finStr:'', fotoInicio:null, fotoInicioData:'', fotoFin:null, fotoFinData:'' };}
let map, mapReady=false, pendingRender=false;

function whenLeafletReady(cb){ if(window.L) return cb(); const iv=setInterval(()=>{ if(window.L){ clearInterval(iv); cb(); }},30); window.addEventListener('load', ()=>{ if(window.L){ clearInterval(iv); cb(); }}); }
function initMap(){ if(map) return; map=L.map('map'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],16),()=>map.setView([14.0723,-87.1921],7),{enableHighAccuracy:true,timeout:6000})} else { map.setView([14.0723,-87.1921],7) } map.on('click',onMapClick); mapReady=true; if(pendingRender){ pendingRender=false; renderAll(); } }
whenLeafletReady(initMap);

function onMapClick(e){
  if(!state._tapMode) return;
  const p = {lat:+e.latlng.lat, lng:+e.latlng.lng, ts:Date.now()};
  if(state._tapMode==='inicio'){ setInicio(p,true); toast('Inicio fijado'); }
  if(state._tapMode==='fin'){ setFin(p,true); toast('Final fijado'); }
  state._tapMode=null;
}
function setInicio(p,fit){ state.actual.inicio=p; state.actual.inicioStr=`${p.lat},${p.lng}`; if(state.mkI){ try{ map.removeLayer(state.mkI) }catch(_){}} state.mkI=L.marker([p.lat,p.lng],{draggable:true}).addTo(map).bindPopup('Arrastra para ajustar inicio'); state.mkI.on('dragend',ev=>{const ll=ev.target.getLatLng(); state.actual.inicio={lat:+ll.lat,lng:+ll.lng,ts:Date.now()}; state.actual.inicioStr=`${+ll.lat},${+ll.lng}`;}); if(fit) map.setView([p.lat,p.lng],16); }
function setFin(p,fit){ state.actual.fin=p; state.actual.finStr=`${p.lat},${p.lng}`; if(state.mkF){ try{ map.removeLayer(state.mkF) }catch(_){}} state.mkF=L.marker([p.lat,p.lng],{draggable:true}).addTo(map).bindPopup('Arrastra para ajustar final'); state.mkF.on('dragend',ev=>{const ll=ev.target.getLatLng(); state.actual.fin={lat:+ll.lat,lng:+ll.lng,ts:Date.now()}; state.actual.finStr=`${+ll.lat},${+ll.lng}`;}); if(fit) map.setView([p.lat,p.lng],16); }

function hasPoint(p){ return p && typeof p.lat==='number' && !isNaN(p.lat) && typeof p.lng==='number' && !isNaN(p.lng); }
function normPoint(p){ if(!p) return null; if(typeof p==='string'){ const a=p.split(',').map(Number); if(a.length===2 && !isNaN(a[0]) && !isNaN(a[1])) return {lat:a[0],lng:a[1]}; return null;} if(typeof p.lat==='number' && typeof p.lng==='number') return {lat:+p.lat,lng:+p.lng}; return null; }

// ==== Fotos ====
async function fileToDataURL(file){ return await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(fr.error); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); }); }
async function compressToBlob(file){ // simple, compatible
  const dataUrl = await fileToDataURL(file);
  // Creamos Blob a partir de dataURL (mantiene compatibilidad)
  const arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]); let n=bstr.length; const u8 = new Uint8Array(n); while(n--){u8[n]=bstr.charCodeAt(n);} return new Blob([u8],{type:mime});
}
function photoSrc(it,which){
  const urlKey = which==='inicio'?'fotoInicioUrl':'fotoFinUrl';
  const dataKey= which==='inicio'?'fotoInicioData':'fotoFinData';
  const blobKey= which==='inicio'?'fotoInicio':'fotoFin';
  if(it[urlKey]) return it[urlKey];
  if(it[dataKey]) return it[dataKey];
  const b = it[blobKey];
  if(b && b instanceof Blob){
    const key = it.id+':'+blobKey;
    if(!state._objUrls.has(key)) state._objUrls.set(key, URL.createObjectURL(b));
    return state._objUrls.get(key);
  }
  return '';
}

// ==== IndexedDB ====
const DB='brechas-db', STORE='items', VER=2; let db;
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,VER); r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains(STORE)){const os=db.createObjectStore(STORE,{keyPath:'id'}); os.createIndex('synced','synced',{unique:false});}}; r.onsuccess=()=>{db=r.result;res(db)}; r.onerror=()=>rej(r.error);});}
function idbAll(){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const os=tx.objectStore(STORE);const rq=os.getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error);});}
function idbPut(it){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);tx.objectStore(STORE).put(it);});}

// ==== Carga/Sincronizaci√≥n ====
const APPS_SCRIPT_URL="/api/sync";
async function fetchAll(){ try{ const r=await fetch(APPS_SCRIPT_URL+'?mode=all'); if(!r.ok) throw new Error(r.status); const data=await r.json(); return (data.records||[]).map(row=>({ id:row.id, sector:row.sector||'', subestacion:row.subestacion||'', circuito:row.circuito||'', tipo:row.tipo||'Apertura', inicio: normPoint(row.inicio), inicioStr: row.inicio||'', fin: normPoint(row.fin), finStr: row.fin||'', fotoInicioUrl: row.fotoInicioUrl||'', fotoFinUrl: row.fotoFinUrl||'', createdAt: row.createdAt||new Date().toISOString(), synced:true })); }catch(_){ return []; } }

function markerPopupHtml(p,t,src,meta){ const coords = hasPoint(p) ? `Lat: ${p.lat.toFixed(6)} ¬∑ Lng: ${p.lng.toFixed(6)}` : 'Coordenadas no v√°lidas'; const img = src ? `<img class="popup-img" loading="lazy" src="${src}" alt="foto"/>` : '<div style="color:#8aa0b6">Sin foto</div>'; return `<div style="min-width:220px"><div style="font-weight:800">${t}</div><div style="color:#9fb3c7">${coords}</div><div style="color:#9fb3c7">${meta}</div>${img}</div>`; }
function addLayer(l){ state.layers.push(l); if(map) l.addTo(map); }
function clearLayers(){ if(!map) return; state.layers.forEach(l=>{try{map.removeLayer(l)}catch(_){}}); state.layers=[]; }
function drawItem(it,fit=false){ if(!hasPoint(it.inicio)||!hasPoint(it.fin)) return; const col=it.tipo==='Limpieza'?'#22c55e':'#f97316'; const line=L.polyline([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]],{color:col,weight:5,opacity:.95}); const mkI=L.circleMarker([it.inicio.lat,it.inicio.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); const mkF=L.circleMarker([it.fin.lat,it.fin.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); mkI.bindPopup(()=>markerPopupHtml(it.inicio,`INICIO ‚Äî ${it.circuito}`, photoSrc(it,'inicio'), `${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ ${it.tipo}`)); mkF.bindPopup(()=>markerPopupHtml(it.fin,`FINAL ‚Äî ${it.circuito}`, photoSrc(it,'fin'), `${it.sector} ‚Ä¢ ${it.subestacion} ‚Ä¢ ${it.tipo}`)); addLayer(line); addLayer(mkI); addLayer(mkF); if(fit){ const b=L.latLngBounds([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]]); map.fitBounds(b.pad(0.3)); } }
function renderAll(){ if(!map) return; clearLayers(); state.items.forEach(it=>drawItem(it,false)); }

async function bootstrap(){ await idbOpen(); const local = await idbAll(); const server = await fetchAll(); const idsLocal=new Set(local.map(x=>x.id)); const merged=[...server, ...local.filter(x=>!x.synced), ...server.filter(x=>!idsLocal.has(x.id)&&x.synced)]; state.items = merged.map(it=>({ ...it, inicio: normPoint(it.inicio||it.inicioStr), fin: normPoint(it.fin||it.finStr) })); if(mapReady) renderAll(); $('pendingBadge').style.display = state.items.some(x=>!x.synced)?'inline-block':'none'; $('pendingBadge').textContent = state.items.filter(x=>!x.synced).length+' pendiente(s)'; }
bootstrap();

// ==== UI flujo ====
function openSheet(){ $('sheet').classList.add('open'); }
function closeSheet(){ $('sheet').classList.remove('open'); setStep(1); state.actual=baseActual(); if(state.mkI){try{map.removeLayer(state.mkI)}catch(_){}} if(state.mkF){try{map.removeLayer(state.mkF)}catch(_){}} }
function show(id){ $(id).classList.remove('hidden'); } function hide(id){ $(id).classList.add('hidden'); }
function setStep(n){ ['step-1','step-2','step-3','step-4'].forEach(hide); show('step-'+n); }

$('newTramo').onclick=()=>{ openSheet(); setStep(1); };
$('s1-cancel').onclick=closeSheet;
$('s1-next').onclick=()=>{
  const sector=$('sector').value.trim(), sub=$('subestacion').value.trim(), circ=$('circuito').value.trim();
  if(!sector||!sub||!circ){ toast('Completa Sector, Subestaci√≥n y Circuito'); return; }
  Object.assign(state.actual,{sector,subestacion:sub,circuito:circ,tipo:$('tipo').value});
  setStep(2);
};

$('cap-inicio').onclick=()=>{
  if(!navigator.geolocation){ toast('GPS no disponible'); return; }
  navigator.geolocation.getCurrentPosition(p=>{ setInicio({lat:+p.coords.latitude,lng:+p.coords.longitude,ts:Date.now()}, true); }, _=>toast('No se pudo obtener GPS'), {enableHighAccuracy:true,timeout:12000,maximumAge:0});
};
$('cap-inicio-tap').onclick=()=>{ state._tapMode='inicio'; toast('Toca el mapa para fijar INICIO'); };

$('s2-back').onclick=()=>setStep(1);
$('s2-next').onclick=async ()=>{
  if(!hasPoint(state.actual.inicio)){ toast('Fija el punto INICIO (GPS o tocando mapa)'); return; }
  const f=$('fotoInicio').files[0]; if(!f){ toast('Selecciona la foto de inicio'); return; }
  try{ state.actual.fotoInicio = await compressToBlob(f); state.actual.fotoInicioData = await fileToDataURL(f); $('previewInicio').src = state.actual.fotoInicioData; $('previewInicioWrap').classList.remove('hidden'); }catch(_){ toast('No se pudo procesar la foto de inicio'); return; }
  setStep(3);
};

$('cap-fin').onclick=()=>{
  if(!navigator.geolocation){ toast('GPS no disponible'); return; }
  navigator.geolocation.getCurrentPosition(p=>{ setFin({lat:+p.coords.latitude,lng:+p.coords.longitude,ts:Date.now()}, true); }, _=>toast('No se pudo obtener GPS'), {enableHighAccuracy:true,timeout:12000,maximumAge:0});
};
$('cap-fin-tap').onclick=()=>{ state._tapMode='fin'; toast('Toca el mapa para fijar FINAL'); };

$('s3-back').onclick=()=>setStep(2);
$('s3-next').onclick=async ()=>{
  if(!hasPoint(state.actual.fin)){ toast('Fija el punto FINAL (GPS o tocando mapa)'); return; }
  const f=$('fotoFin').files[0]; if(!f){ toast('Selecciona la foto final'); return; }
  try{ state.actual.fotoFin = await compressToBlob(f); state.actual.fotoFinData = await fileToDataURL(f); $('previewFin').src = state.actual.fotoFinData; $('previewFinWrap').classList.remove('hidden'); }catch(_){ toast('No se pudo procesar la foto final'); return; }
  const it=state.actual; const col=it.tipo==='Limpieza'?'#22c55e':'#f97316';
  $('resumen').innerHTML = `<div class="grid">
    <div><b>Sector:</b> ${it.sector}</div><div><b>Subestaci√≥n:</b> ${it.subestacion}</div><div><b>Circuito:</b> ${it.circuito}</div>
    <div><b>Tipo:</b> <span style="color:${col}">${it.tipo}</span></div>
    <div><b>Inicio:</b> ${it.inicio.lat.toFixed(6)}, ${it.inicio.lng.toFixed(6)}</div>
    <div><b>Final:</b> ${it.fin.lat.toFixed(6)}, ${it.fin.lng.toFixed(6)}</div>
  </div>`;
  setStep(4);
};

$('s4-cancel').onclick=closeSheet;
$('s4-save').onclick=async ()=>{
  if(!hasPoint(state.actual.inicio) || !hasPoint(state.actual.fin)){ toast('Faltan coordenadas v√°lidas'); return; }
  const it={ id:crypto.randomUUID(), ...state.actual, createdAt:new Date().toISOString(), synced:false };
  state.items.push(it);
  await idbPut(it);
  drawItem({ ...it }, true);
  $('pendingBadge').style.display='inline-block'; $('pendingBadge').textContent = state.items.filter(x=>!x.synced).length+' pendiente(s)';
  toast('Guardado local');
  closeSheet();
};

// No implementamos sync real aqu√≠; el popup usar√° fotoInicioData/fotoFinData inmediatamente.
$('syncBtn').onclick=()=>toast('Demo: implementa tu endpoint en /api/sync');

</script>
</body>
</html>
