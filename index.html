<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Captura de Brechas (Cloudflare API)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#0b1220;--card:#0f182a;--muted:#8aa0b6;--text:#ecf3ff;--accent:#4cc9f0;--ok:#22c55e;--warn:#f97316;--danger:#ef4444;--border:#1d2a45;--sheet:#0b1220;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35);}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text);overflow:hidden}
    header{position:fixed;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:10px;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:12px 14px}
    header h1{margin:0;font-size:16px} header .muted{color:var(--muted);font-size:12px}
    #map{position:absolute;inset:52px 0 0 0}
    .fab{position:fixed;right:16px;bottom:16px;z-index:1100;border:0;border-radius:999px;background:var(--accent);color:#051423;padding:14px 16px;font-weight:800;box-shadow:var(--shadow);}
    .fab:active{transform:translateY(1px)}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:2000;background:var(--sheet);border-top-left-radius:20px;border-top-right-radius:20px;border:1px solid var(--border);box-shadow:0 -12px 30px rgba(0,0,0,.45);transition:bottom .28s ease;max-height:82vh;display:flex;flex-direction:column}
    .sheet.open{bottom:0} .sheet .drag{width:56px;height:5px;border-radius:999px;background:#24314f;margin:8px auto} .sheet .content{padding:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} .field{display:flex;flex-direction:column;gap:6px} label{font-size:12px;color:var(--muted)}
    input[type="text"],select,input[type="file"]{width:100%;background:#0e1729;color:var(--text);border:1px solid #1f2c49;border-radius:12px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:#183055;color:#e6f0ff;width:100%;font-weight:700;cursor:pointer} .btn[disabled]{opacity:.7;cursor:not-allowed}
    .btn-primary{background:var(--accent);color:#051423} .btn-ok{background:var(--ok);color:#06240e} .btn-warn{background:var(--warn);color:#2b0d02} .btn-ghost{background:#0e1729;border:1px solid #203153;color:#d7e5ff} .btn-danger{background:var(--danger);}
    .bar{display:grid;grid-template-columns:1fr 1fr;gap:10px} .chips{display:flex;gap:8px;flex-wrap:wrap} .chip{padding:6px 10px;border-radius:999px;background:#0e1729;border:1px solid #22355c;font-size:12px;color:var(--muted)}
    .color-box{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle} .apertura{background:var(--warn)} .limpieza{background:var(--ok)}
    .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)} .hidden{display:none!important}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px} .grid{display:grid;gap:8px}
    img.preview{width:160px;height:auto;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:transform .2s ease} img.preview:hover{transform:scale(1.05)}
    .popup-title{font-weight:800;margin-bottom:4px} .popup-meta{font-size:12px;color:#9fb3c7} .popup-img{width:200px;max-width:80vw;border-radius:10px;margin-top:6px;border:1px solid #1f2c49}
    .pending-banner{position:fixed;left:0;right:0;bottom:0;z-index:1500;background:#2a1d0b;color:#ffe7c2;border-top:1px solid #4b2e0f;padding:8px 12px;font-size:13px;display:none} .pending-banner strong{color:#ffd39a}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:2200;background:#0e1729;color:#eaf2ff;border:1px solid #203153;border-radius:10px;padding:10px 14px;box-shadow:var(--shadow);display:none}
  </style>
</head>
<body>
  <header>
    <h1>Captura de Brechas</h1>
    <span class="muted">Móvil • GPS • Fotos</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="pendingBadge" class="chip" style="display:none"></span>
      <button id="syncBtn" class="btn btn-ghost" style="padding:8px 10px">🔄 Sincronizar</button>
    </div>
  </header>

  <div id="map"></div>
  <div id="pendingBanner" class="pending-banner">Tienes <strong id="pendingCount">0</strong> reporte(s) pendientes de sincronizar.</div>
  <div id="toast" class="toast"></div>
  <button id="newTramo" class="fab">+ Nuevo tramo</button>

  <section id="sheet" class="sheet" aria-modal="true" role="dialog">
    <div class="drag"></div>
    <div class="content">
      <div id="step-1" class="grid">
        <div class="card">
          <div class="chips" style="margin-bottom:8px">
            <span class="chip"><span class="color-box apertura"></span>Apertura</span>
            <span class="chip"><span class="color-box limpieza"></span>Limpieza</span>
          </div>
          <div class="row">
            <div class="field"><label>Sector</label><input id="sector" type="text" placeholder="Ej: Norte"></div>
            <div class="field"><label>Subestación</label><input id="subestacion" type="text" placeholder="Ej: S/E Progreso"></div>
          </div>
          <div class="row">
            <div class="field"><label>Circuito</label><input id="circuito" type="text" placeholder="Ej: CIR-123"></div>
            <div class="field"><label>Tipo de brecha</label>
              <select id="tipo"><option value="Apertura">Apertura de brecha</option><option value="Limpieza">Limpieza de brecha</option></select>
            </div>
          </div>
          <div class="note">Completa y pulsa <strong>Siguiente</strong>.</div>
          <div class="bar" style="margin-top:10px">
            <button id="s1-cancel" class="btn btn-ghost">Cancelar</button>
            <button id="s1-next" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>

      <div id="step-2" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 2:</strong> Capturar <u>punto inicial</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-inicio" class="btn btn-primary">Captar punto inicial (GPS)</button>
          <div class="field"><label>Foto punto inicial (requerida)</label><input id="fotoInicio" type="file" accept="image/*" capture="environment"></div>
          <div id="previewInicioWrap" class="hidden"><img id="previewInicio" class="preview" alt="Foto inicio"/></div>
          <div class="bar"><button id="s2-back" class="btn btn-ghost">Atrás</button><button id="s2-next" class="btn btn-primary">Siguiente</button></div>
        </div>
      </div>

      <div id="step-3" class="grid hidden">
        <div class="card grid">
          <div><strong>Paso 3:</strong> Capturar <u>punto final</u> y subir <u>foto obligatoria</u>.</div>
          <button id="cap-fin" class="btn btn-primary">Captar punto final (GPS)</button>
          <div class="field"><label>Foto punto final (requerida)</label><input id="fotoFin" type="file" accept="image/*" capture="environment"></div>
          <div id="previewFinWrap" class="hidden"><img id="previewFin" class="preview" alt="Foto final"/></div>
          <div class="bar"><button id="s3-back" class="btn btn-ghost">Atrás</button><button id="s3-next" class="btn btn-primary">Siguiente</button></div>
        </div>
      </div>

      <div id="step-4" class="grid hidden">
        <div class="card grid">
          <div><strong>Resumen</strong> — revisa y guarda.</div>
          <div id="resumen" class="grid"></div>
          <div class="bar"><button id="s4-cancel" class="btn btn-ghost">Cancelar</button><button id="s4-save" class="btn btn-ok">Guardar tramo</button></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    const APPS_SCRIPT_URL = "/api/sync";
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
    function locate(){ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition((pos)=>{ map.setView([pos.coords.latitude,pos.coords.longitude],17); }, ()=>map.setView([14.0723,-87.1921],7), {enableHighAccuracy:true, timeout:10000}); } else map.setView([14.0723,-87.1921],7); } locate();
    const $=(id)=>document.getElementById(id); const sheet=$("sheet"); let step=1;
    const state={ actual:{ sector:"",subestacion:"",circuito:"",tipo:"Apertura",inicio:null,fin:null,fotoInicio:null,fotoFin:null }, items:[], layers:[], mkInicioTemp:null, mkFinTemp:null };
    try{ state.items=JSON.parse(localStorage.getItem("brechas_items")||"[]"); }catch{} renderAll(); updatePendingUI();
    function openSheet(){ sheet.classList.add("open"); } function closeSheet(){ sheet.classList.remove("open"); setStep(1); clearWizard(false); }
    function show(id){ $(id).classList.remove("hidden"); } function hide(id){ $(id).classList.add("hidden"); }
    function setStep(n){ step=n; ["step-1","step-2","step-3","step-4"].forEach(s=>hide(s)); show("step-"+n); }
    function tipoColor(t){ return (t==="Limpieza")?"#22c55e":"#f97316"; }
    function addLayer(layer){ state.layers.push(layer); layer.addTo(map); } function clearMapLayers(){ state.layers.forEach(l=>map.removeLayer(l)); state.layers=[]; }
    function fileToDataURL(file){ return new Promise((resolve,reject)=>{ if(!file) return resolve(null); const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); });}
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }
    async function getGPS(){ return new Promise((resolve,reject)=>{ if(!navigator.geolocation) return reject(new Error("Geolocalización no disponible")); navigator.geolocation.getCurrentPosition(pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude,ts:Date.now()}), err=>reject(err), {enableHighAccuracy:true,timeout:15000,maximumAge:0});});}
    function markerPopupHtml(p,titulo,fotoDataUrl,meta){ const imgHtml=fotoDataUrl?'<img class="popup-img" src="'+fotoDataUrl+'" alt="foto"/>':'<div class="popup-meta">Sin foto</div>'; return `<div style="min-width:220px"><div class="popup-title">${titulo}</div><div class="popup-meta">Lat: ${p.lat.toFixed(6)} · Lng: ${p.lng.toFixed(6)}</div><div class="popup-meta">${meta}</div>${imgHtml}</div>`;}
    function drawItem(it,fit=false){ const col=tipoColor(it.tipo); const line=L.polyline([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]],{color:col,weight:5,opacity:.95}); addLayer(line);
      const mkIni=L.circleMarker([it.inicio.lat,it.inicio.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); mkIni.bindPopup(()=>markerPopupHtml(it.inicio,`INICIO — ${it.circuito}`,(it.fotoInicioUrl||it.fotoInicio),`${it.sector} • ${it.subestacion} • ${it.tipo}`)); addLayer(mkIni);
      const mkFin=L.circleMarker([it.fin.lat,it.fin.lng],{radius:7,color:col,fillColor:col,fillOpacity:.95}); mkFin.bindPopup(()=>markerPopupHtml(it.fin,`FINAL — ${it.circuito}`,(it.fotoFinUrl||it.fotoFin),`${it.sector} • ${it.subestacion} • ${it.tipo}`)); addLayer(mkFin);
      line.on("click",()=>{ const mid=[(it.inicio.lat+it.fin.lat)/2,(it.inicio.lng+it.fin.lng)/2]; const html=`<div style="min-width:240px"><div class="popup-title">${it.sector} • ${it.subestacion}</div><div class="popup-meta">Circuito: <b>${it.circuito}</b> — <span style="color:${col}">${it.tipo}</span></div><div class="popup-meta">${new Date(it.createdAt).toLocaleString()}</div><div class="popup-meta">Inicio: ${it.inicio.lat.toFixed(6)}, ${it.inicio.lng.toFixed(6)}</div><div class="popup-meta">Final: ${it.fin.lat.toFixed(6)}, ${it.fin.lng.toFixed(6)}</div>${(it.fotoInicioUrl||it.fotoInicio)?`<div style="margin-top:6px">Foto inicio:</div><img class="popup-img" src="${it.fotoInicioUrl||it.fotoInicio}"/>`:''}${(it.fotoFinUrl||it.fotoFin)?`<div style="margin-top:6px">Foto final:</div><img class="popup-img" src="${it.fotoFinUrl||it.fotoFin}"/>`:''}</div>`; L.popup().setLatLng(mid).setContent(html).openOn(map);});
      if(fit){ const b=L.latLngBounds([[it.inicio.lat,it.inicio.lng],[it.fin.lat,it.fin.lng]]); map.fitBounds(b.pad(0.3)); } }
    function renderAll(){ clearMapLayers(); state.items.forEach(it=>drawItem(it,false)); }
    function clearWizard(resetAll=true){ if(resetAll){ state.actual={sector:"",subestacion:"",circuito:"",tipo:"Apertura",inicio:null,fin:null,fotoInicio:null,fotoFin:null}; } else { state.actual.inicio=null; state.actual.fin=null; state.actual.fotoInicio=null; state.actual.fotoFin=null; } $("sector").value=""; $("subestacion").value=""; $("circuito").value=""; $("tipo").value="Apertura"; $("fotoInicio").value=""; $("fotoFin").value=""; $("previewInicioWrap").classList.add("hidden"); $("previewFinWrap").classList.add("hidden"); $("previewInicio").src=""; $("previewFin").src=""; }
    function validateStep1(){ const sector=$("sector").value.trim(); const sub=$("subestacion").value.trim(); const circ=$("circuito").value.trim(); if(!sector||!sub||!circ) return false; state.actual.sector=sector; state.actual.subestacion=sub; state.actual.circuito=circ; state.actual.tipo=$("tipo").value; return true; }
    async function validateStep2(){ if(!state.actual.inicio){ try{ await capInicio(); }catch{} } const f=$("fotoInicio").files[0]; if(!state.actual.inicio||!f) return false; state.actual.fotoInicio=await fileToDataURL(f); $("previewInicio").src=state.actual.fotoInicio; $("previewInicioWrap").classList.remove("hidden"); return true; }
    async function validateStep3(){ if(!state.actual.fin){ try{ await capFin(); }catch{} } const f=$("fotoFin").files[0]; if(!state.actual.fin||!f) return false; state.actual.fotoFin=await fileToDataURL(f); $("previewFin").src=state.actual.fotoFin; $("previewFinWrap").classList.remove("hidden"); return true; }
    function fillResumen(){ const it=state.actual; const col=tipoColor(it.tipo); const wrap=document.createElement('div'); wrap.className='grid'; function addLine(label,valueHtml){ const d=document.createElement('div'); d.innerHTML='<b>'+label+':</b> '+valueHtml; wrap.appendChild(d);} addLine('Sector',it.sector||'-'); addLine('Subestación',it.subestacion||'-'); addLine('Circuito',it.circuito||'-'); addLine('Tipo','<span style="color:'+col+'">'+it.tipo+'</span>'); addLine('Inicio',it.inicio?(it.inicio.lat.toFixed(6)+', '+it.inicio.lng.toFixed(6)):'-'); addLine('Final',it.fin?(it.fin.lat.toFixed(6)+', '+it.fin.lng.toFixed(6)):'-'); wrap.appendChild(document.createElement('div')).innerHTML='<b>Foto inicio:</b>'; if(it.fotoInicio){ const img=document.createElement('img'); img.className='preview'; img.alt='Foto inicio'; img.src=it.fotoInicio; wrap.appendChild(img);} else { const n=document.createElement('div'); n.className='note'; n.textContent='Sin foto'; wrap.appendChild(n);} wrap.appendChild(document.createElement('div')).innerHTML='<b>Foto final:</b>'; if(it.fotoFin){ const img=document.createElement('img'); img.className='preview'; img.alt='Foto final'; img.src=it.fotoFin; wrap.appendChild(img);} else { const n=document.createElement('div'); n.className='note'; n.textContent='Sin foto'; wrap.appendChild(n);} const cont=document.getElementById('resumen'); cont.innerHTML=''; cont.appendChild(wrap); }
    async function capInicio(){ const p=await getGPS(); state.actual.inicio=p; if(state.mkInicioTemp){ try{ map.removeLayer(state.mkInicioTemp);}catch(_){}} const mk=L.marker([p.lat,p.lng],{title:"Inicio (ajustable)",draggable:true}); mk.bindPopup("Arrastra para ajustar inicio"); mk.on("dragend",(e)=>{ const ll=e.target.getLatLng(); state.actual.inicio={lat:ll.lat,lng:ll.lng,ts:Date.now()};}); addLayer(mk); state.mkInicioTemp=mk; try{ mk.setZIndexOffset&&mk.setZIndexOffset(1000);}catch(_){} try{ map.flyTo([p.lat,p.lng], Math.max(map.getZoom(),18), {duration:0.6}); }catch(_){ map.setView([p.lat,p.lng],18);} setTimeout(()=>{ try{ mk.openPopup(); }catch(_){} },150); toast("📍 Punto inicial capturado"); }
    async function capFin(){ const p=await getGPS(); state.actual.fin=p; if(state.mkFinTemp){ try{ map.removeLayer(state.mkFinTemp);}catch(_){}} const mk=L.marker([p.lat,p.lng],{title:"Final (ajustable)",draggable:true}); mk.bindPopup("Arrastra para ajustar final"); mk.on("dragend",(e)=>{ const ll=e.target.getLatLng(); state.actual.fin={lat:ll.lat,lng:ll.lng,ts:Date.now()};}); addLayer(mk); state.mkFinTemp=mk; try{ mk.setZIndexOffset&&mk.setZIndexOffset(1000);}catch(_){} try{ map.flyTo([p.lat,p.lng], Math.max(map.getZoom(),18), {duration:0.6}); }catch(_){ map.setView([p.lat,p.lng],18);} setTimeout(()=>{ try{ mk.openPopup(); }catch(_){} },150); toast("📍 Punto final capturado"); }
    $("newTramo").onclick=()=>{ openSheet(); setStep(1); };
    $("s1-cancel").onclick=closeSheet;
    $("s1-next").onclick=()=>{ if(!validateStep1()){ alert("Completa Sector, Subestación y Circuito."); return;} setStep(2); };
    $("s2-back").onclick=()=> setStep(1);
    $("s2-next").onclick=async()=>{ const ok=await validateStep2(); if(!ok){ alert("Captura el punto inicial y selecciona una foto."); return;} setStep(3); };
    $("s3-back").onclick=()=> setStep(2);
    $("s3-next").onclick=async()=>{ const ok=await validateStep3(); if(!ok){ alert("Captura el punto final y selecciona una foto."); return;} fillResumen(); setStep(4); };
    $("s4-cancel").onclick=()=>{ closeSheet(); };
    $("s4-save").onclick=async()=>{
      const it={ id:crypto.randomUUID(), sector:state.actual.sector, subestacion:state.actual.subestacion, circuito:state.actual.circuito, tipo:state.actual.tipo, inicio:state.actual.inicio, fin:state.actual.fin, fotoInicio:state.actual.fotoInicio, fotoFin:state.actual.fotoFin, createdAt:new Date().toISOString() };
      state.items.push(it); localStorage.setItem("brechas_items", JSON.stringify(state.items));
      drawItem(it,true); closeSheet();
      try{ if(state.mkInicioTemp){ map.removeLayer(state.mkInicioTemp); state.mkInicioTemp=null; } }catch(_){}
      try{ if(state.mkFinTemp){ map.removeLayer(state.mkFinTemp); state.mkFinTemp=null; } }catch(_){}
      renderAll(); updatePendingUI();
      // Auto-sync right after save (best-effort)
      try{
        const pendientes = state.items.filter(x=>!x.synced);
        if(pendientes.length){
          const data = await syncToSheet(pendientes);
          const okIds = new Set(data.syncedIds || []);
          const urlMap = data.urlMap || {};
          state.items = state.items.map(x => okIds.has(x.id)
            ? ({ ...x, synced:true, fotoInicioUrl:(urlMap[x.id]?.inicio)||x.fotoInicioUrl||null, fotoFinUrl:(urlMap[x.id]?.fin)||x.fotoFinUrl||null })
            : x
          );
          localStorage.setItem("brechas_items", JSON.stringify(state.items));
          renderAll(); updatePendingUI();
          toast("✅ Guardado y sincronizado");
        }
      }catch(e){ console.warn("Autosync falló, quedará pendiente:", e); toast("⚠️ Guardado offline (pendiente)"); }
    };
    function getPendingCount(){ try{ return (state.items||[]).filter(it=>!it.synced).length; }catch{ return 0; } }
    function updatePendingUI(){ const n=getPendingCount(); const badge=$("pendingBadge"); const banner=$("pendingBanner"); const countEl=$("pendingCount"); if(badge){ if(n>0){ badge.style.display='inline-block'; badge.textContent=n+' pendiente(s)'; } else { badge.style.display='none'; } } if(banner){ if(n>0){ banner.style.display='block'; if(countEl) countEl.textContent=n; } else { banner.style.display='none'; } } }
    async function syncToSheet(pendientes){ const payload={records:pendientes}; const res=await fetch(APPS_SCRIPT_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) }); if(!res.ok) throw new Error("HTTP "+res.status); return await res.json(); }
    const syncBtn=$("syncBtn"); if(syncBtn){ syncBtn.addEventListener("click", async ()=>{ const n=getPendingCount(); if(n===0){ toast("No hay reportes pendientes."); return; } syncBtn.disabled=true; const old=syncBtn.textContent; syncBtn.textContent="⏳ Sincronizando..."; try{ const pendientes=state.items.filter(it=>!it.synced); const data=await syncToSheet(pendientes); const okIds=new Set(data.syncedIds||[]); const urlMap=data.urlMap||{}; state.items=state.items.map(it=> okIds.has(it.id) ? ({...it,synced:true,fotoInicioUrl:(urlMap[it.id]?.inicio)||it.fotoInicioUrl||null,fotoFinUrl:(urlMap[it.id]?.fin)||it.fotoFinUrl||null}) : it ); localStorage.setItem("brechas_items", JSON.stringify(state.items)); renderAll(); updatePendingUI(); toast("✅ Sincronización completa"); } catch(e){ console.error(e); toast("❌ Error al sincronizar"); } finally { syncBtn.disabled=false; syncBtn.textContent=old; } }); }
    document.addEventListener('click', (e)=>{ const el=e.target; if(el&&el.classList&&el.classList.contains('preview')){ try{ window.open(el.src,'_blank'); }catch(_){} } });
  </script>
</body>
</html>
